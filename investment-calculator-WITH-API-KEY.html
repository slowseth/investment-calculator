<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Allocation Calculator</title>
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3Q3LVYK5PH"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-3Q3LVYK5PH');
    </script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // Lucide React icons as inline SVGs
        const DollarSign = ({ className }) => (
            <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
        );

        const TrendingUp = ({ className }) => (
            <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                <polyline points="17 6 23 6 23 12"></polyline>
            </svg>
        );

        const Percent = ({ className }) => (
            <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="19" y1="5" x2="5" y2="19"></line>
                <circle cx="6.5" cy="6.5" r="2.5"></circle>
                <circle cx="17.5" cy="17.5" r="2.5"></circle>
            </svg>
        );

        const Info = ({ className }) => (
            <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
        );

        const Sliders = ({ className }) => (
            <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="4" y1="21" x2="4" y2="14"></line>
                <line x1="4" y1="10" x2="4" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12" y2="3"></line>
                <line x1="20" y1="21" x2="20" y2="16"></line>
                <line x1="20" y1="12" x2="20" y2="3"></line>
                <line x1="1" y1="14" x2="7" y2="14"></line>
                <line x1="9" y1="8" x2="15" y2="8"></line>
                <line x1="17" y1="16" x2="23" y2="16"></line>
            </svg>
        );

        const Sparkles = ({ className }) => (
            <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path>
                <path d="M5 3v4"></path>
                <path d="M19 17v4"></path>
                <path d="M3 5h4"></path>
                <path d="M17 19h4"></path>
            </svg>
        );

        const Mail = ({ className }) => (
            <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path>
            </svg>
        );

        const Download = ({ className }) => (
            <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );

        function InvestmentCalculator() {
            const [mode, setMode] = useState('guided'); // 'guided', 'custom', or 'rebalance'
            const [investmentAmount, setInvestmentAmount] = useState(10000);
            
            // Current holdings for rebalance mode
            const [currentHoldings, setCurrentHoldings] = useState([
                { ticker: 'VOO', shares: 0, price: 0, amount: 0, type: 'etf', purchaseDate: '' } // type: 'etf' or 'stock'
            ]);
            
            const [age, setAge] = useState(30); // User's current age
            const [timeHorizon, setTimeHorizon] = useState(10); // Years
            const [usAllocation, setUsAllocation] = useState(70);
            const [bondAllocation, setBondAllocation] = useState(0); // Bonds percentage
            const [recurringContribution, setRecurringContribution] = useState(0);
            const [contributionFrequency, setContributionFrequency] = useState('monthly'); // 'daily', 'weekly', 'monthly', 'quarterly', 'annually'
            const [userEmail, setUserEmail] = useState('');
            const [isGeneratingPDF, setIsGeneratingPDF] = useState(false);
            const [isSendingEmail, setIsSendingEmail] = useState(false);
            const [stressTestExpanded, setStressTestExpanded] = useState(false);
            const [stressTestTab, setStressTestTab] = useState('historical'); // 'historical', 'what-if', 'vs-cash'
            const [projectionsExpanded, setProjectionsExpanded] = useState(false);
            const [isUploadingFile, setIsUploadingFile] = useState(false);
            const [isFetchingPrices, setIsFetchingPrices] = useState(false);
            const [lastPriceUpdate, setLastPriceUpdate] = useState(null);
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            const growthChartRef = useRef(null);
            const growthChartInstance = useRef(null);
            
            // EmailJS Configuration - FULLY CONFIGURED ✓
            const EMAILJS_SERVICE_ID = 'service_matdwtu';
            const EMAILJS_TEMPLATE_ID_USER = 'template_kavkiwn';
            const EMAILJS_TEMPLATE_ID_OWNER = 'template_7m720gr';
            const EMAILJS_PUBLIC_KEY = 'emAaG0VJoZvPPV3BA';
            const OWNER_EMAIL = 'hello@slowlabs.co';
            
            // Google Sheets Configuration - FULLY CONFIGURED ✓
            const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbxMjgp59Sm6CcXp6zj3-GZ9sjmcFRx8lD0Rl2f4vQtk_EPJ7YthpddIN06Lw5iD4EmkJA/exec';
            
            // Calculate recommended bond allocation based on age (Rule of 110/120)
            // Rule of 120 for under 50: 120 - age = % in stocks, remainder in bonds
            // Rule of 110 for 50+: 110 - age = % in stocks, remainder in bonds
            const recommendedBondAllocation = isNaN(age) || age === '' 
                ? 20 // Default recommendation if age is invalid
                : Number(age) < 50
                    ? Math.max(0, Math.min(60, Number(age) - 20))  // Rule of 120: bonds = age - 20
                    : Math.max(0, Math.min(60, Number(age) - 10)); // Rule of 110: bonds = age - 10
            
            // Adjust stock allocations to account for bonds
            const stockAllocation = 100 - bondAllocation;
            const internationalAllocation = stockAllocation - usAllocation;
            
            // Auto-calculate expected returns based on portfolio allocation
            // Historical averages: Stocks ~10%, Bonds ~4%
            const stockReturn = 10; // 10% for stocks
            const bondReturn = 4;   // 4% for bonds
            const baseExpectedReturn = ((stockAllocation / 100) * stockReturn) + ((bondAllocation / 100) * bondReturn);
            
            // Create 4 scenarios: Conservative, Expected, Optimistic, Crisis
            const scenarios = {
                conservative: Math.max(3, baseExpectedReturn - 2), // Conservative: -2% from base, minimum 3%
                expected: baseExpectedReturn,                       // Expected: portfolio-based
                optimistic: Math.min(12, baseExpectedReturn + 2),  // Optimistic: +2% from base, maximum 12%
                crisis: 2.5                                         // Crisis: 2.5% (severe downturn, barely beats inflation)
            };
            
            // Inflation rate for real value calculations
            const inflationRate = 0.03; // 3% annual inflation

            // Function to handle CSV file upload
            const handleCSVUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                setIsUploadingFile(true);
                
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        try {
                            // Parse CSV and map to holdings format
                            // Expected CSV columns: Ticker, Shares, Price, Type (optional), PurchaseDate (optional)
                            const parsedHoldings = results.data.map(row => {
                                // Support multiple column name variations
                                const ticker = (row.Ticker || row.Symbol || row.ticker || row.symbol || '').trim().toUpperCase();
                                const shares = parseFloat(row.Shares || row.Quantity || row.shares || row.quantity || 0);
                                const price = parseFloat(row.Price || row['Current Price'] || row.price || row['current price'] || 0);
                                const type = (row.Type || row.type || 'stock').toLowerCase();
                                const purchaseDate = row['Purchase Date'] || row['PurchaseDate'] || row.Date || row.date || '';
                                
                                return {
                                    ticker,
                                    shares,
                                    price,
                                    amount: shares * price,
                                    type: type === 'etf' ? 'etf' : 'stock',
                                    purchaseDate
                                };
                            }).filter(h => h.ticker && h.shares > 0); // Only include valid entries
                            
                            if (parsedHoldings.length > 0) {
                                setCurrentHoldings(parsedHoldings);
                                // Optionally fetch real-time prices after upload
                                fetchRealTimePrices(parsedHoldings);
                            } else {
                                alert('No valid holdings found in CSV. Please ensure your CSV has columns: Ticker, Shares, Price');
                            }
                        } catch (error) {
                            console.error('CSV parsing error:', error);
                            alert('Error parsing CSV file. Please check the format and try again.');
                        }
                        setIsUploadingFile(false);
                    },
                    error: (error) => {
                        console.error('CSV upload error:', error);
                        alert('Error reading CSV file');
                        setIsUploadingFile(false);
                    }
                });
            };

            // Function to fetch real-time prices for all holdings
            const fetchRealTimePrices = async (holdings = currentHoldings) => {
                if (holdings.length === 0) return;
                
                setIsFetchingPrices(true);
                
                try {
                    const updatedHoldings = await Promise.all(
                        holdings.map(async (holding) => {
                            const result = await fetchPriceWithFallback(holding.ticker);
                            
                            if (result.success) {
                                return {
                                    ...holding,
                                    price: result.price,
                                    amount: holding.shares * result.price
                                };
                            }
                            return holding; // Return unchanged if fetch fails
                        })
                    );
                    
                    setCurrentHoldings(updatedHoldings);
                    setLastPriceUpdate(new Date());
                } catch (error) {
                    console.error('Error fetching prices:', error);
                    alert('Error updating prices. Please try again or enter prices manually.');
                }
                
                setIsFetchingPrices(false);
            };

            // Function to fetch price using multiple API sources with fallbacks
            const fetchPriceWithFallback = async (ticker) => {
                // Try method 1: Finnhub with user's API key
                try {
                    const response = await fetch(
                        `https://finnhub.io/api/v1/quote?symbol=${ticker}&token=d44go09r01qt371v0f80d44go09r01qt371v0f8g`,
                        { mode: 'cors' }
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        const quote = data?.c;
                        if (quote && quote > 0) {
                            return { success: true, price: parseFloat(quote.toFixed(2)), source: 'Finnhub' };
                        }
                    }
                } catch (error) {
                    console.log('Finnhub failed, trying next method...', error);
                }
                
                // Try method 2: Alternative endpoint
                try {
                    const response = await fetch(
                        `https://query2.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1d`,
                        { mode: 'cors' }
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        const quote = data?.chart?.result?.[0]?.meta?.regularMarketPrice;
                        if (quote) {
                            return { success: true, price: parseFloat(quote.toFixed(2)), source: 'Yahoo' };
                        }
                    }
                } catch (error) {
                    console.log('Yahoo failed, all methods exhausted', error);
                }
                
                return { success: false, error: 'Could not fetch price from any source' };
            };

            // Function to fetch price for a single ticker (when user enters it)
            const fetchSingleTickerPrice = async (ticker, index) => {
                if (!ticker || ticker.length < 1) return;
                
                const result = await fetchPriceWithFallback(ticker);
                
                if (result.success) {
                    const newHoldings = [...currentHoldings];
                    newHoldings[index].price = result.price;
                    newHoldings[index].amount = newHoldings[index].shares * result.price;
                    setCurrentHoldings(newHoldings);
                } else {
                    console.log(`Could not fetch price for ${ticker} - user can manually enter`);
                }
            };

            // ETF options with real data - expanded with multiple providers
            const etfs = {
                // Vanguard ETFs
                voo: { 
                    name: 'VOO', 
                    fullName: 'Vanguard S&P 500 ETF', 
                    expenseRatio: 0.03, 
                    type: 'US Large Cap',
                    provider: 'Vanguard',
                    dividendYield: 1.5,
                    taxEfficiency: 'Excellent',
                    turnover: 3
                },
                vti: { 
                    name: 'VTI', 
                    fullName: 'Vanguard Total Stock Market ETF', 
                    expenseRatio: 0.03, 
                    type: 'US Total Market',
                    provider: 'Vanguard',
                    dividendYield: 1.5,
                    taxEfficiency: 'Excellent',
                    turnover: 4
                },
                vxus: { 
                    name: 'VXUS', 
                    fullName: 'Vanguard Total International Stock ETF', 
                    expenseRatio: 0.08, 
                    type: 'International',
                    provider: 'Vanguard',
                    dividendYield: 3.2,
                    taxEfficiency: 'Very Good',
                    turnover: 5
                },
                vb: { 
                    name: 'VB', 
                    fullName: 'Vanguard Small-Cap ETF', 
                    expenseRatio: 0.05, 
                    type: 'US Small Cap',
                    provider: 'Vanguard',
                    dividendYield: 1.3,
                    taxEfficiency: 'Very Good',
                    turnover: 15
                },
                vwo: { 
                    name: 'VWO', 
                    fullName: 'Vanguard Emerging Markets ETF', 
                    expenseRatio: 0.08, 
                    type: 'Emerging Markets',
                    provider: 'Vanguard',
                    dividendYield: 3.5,
                    taxEfficiency: 'Good',
                    turnover: 8
                },
                vea: { 
                    name: 'VEA', 
                    fullName: 'Vanguard Developed Markets ETF', 
                    expenseRatio: 0.05, 
                    type: 'Developed International',
                    provider: 'Vanguard',
                    dividendYield: 3.0,
                    taxEfficiency: 'Very Good',
                    turnover: 4
                },
                
                // Schwab ETFs
                schb: { 
                    name: 'SCHB', 
                    fullName: 'Schwab U.S. Broad Market ETF', 
                    expenseRatio: 0.03, 
                    type: 'US Total Market',
                    provider: 'Schwab',
                    dividendYield: 1.4,
                    taxEfficiency: 'Excellent',
                    turnover: 4
                },
                schx: { 
                    name: 'SCHX', 
                    fullName: 'Schwab U.S. Large-Cap ETF', 
                    expenseRatio: 0.03, 
                    type: 'US Large Cap',
                    provider: 'Schwab',
                    dividendYield: 1.5,
                    taxEfficiency: 'Excellent',
                    turnover: 3
                },
                schf: { 
                    name: 'SCHF', 
                    fullName: 'Schwab International Equity ETF', 
                    expenseRatio: 0.06, 
                    type: 'International',
                    provider: 'Schwab',
                    dividendYield: 3.1,
                    taxEfficiency: 'Very Good',
                    turnover: 5
                },
                scha: { 
                    name: 'SCHA', 
                    fullName: 'Schwab U.S. Small-Cap ETF', 
                    expenseRatio: 0.04, 
                    type: 'US Small Cap',
                    provider: 'Schwab',
                    dividendYield: 1.2,
                    taxEfficiency: 'Very Good',
                    turnover: 12
                },
                sche: { 
                    name: 'SCHE', 
                    fullName: 'Schwab Emerging Markets Equity ETF', 
                    expenseRatio: 0.11, 
                    type: 'Emerging Markets',
                    provider: 'Schwab',
                    dividendYield: 3.4,
                    taxEfficiency: 'Good',
                    turnover: 9
                },
                
                // iShares Core ETFs (BlackRock)
                itot: { 
                    name: 'ITOT', 
                    fullName: 'iShares Core S&P Total U.S. Stock Market ETF', 
                    expenseRatio: 0.03, 
                    type: 'US Total Market',
                    provider: 'iShares',
                    dividendYield: 1.4,
                    taxEfficiency: 'Excellent',
                    turnover: 3
                },
                ivv: { 
                    name: 'IVV', 
                    fullName: 'iShares Core S&P 500 ETF', 
                    expenseRatio: 0.03, 
                    type: 'US Large Cap',
                    provider: 'iShares',
                    dividendYield: 1.5,
                    taxEfficiency: 'Excellent',
                    turnover: 3
                },
                ixus: { 
                    name: 'IXUS', 
                    fullName: 'iShares Core MSCI Total International Stock ETF', 
                    expenseRatio: 0.07, 
                    type: 'International',
                    provider: 'iShares',
                    dividendYield: 3.3,
                    taxEfficiency: 'Very Good',
                    turnover: 5
                },
                ijr: { 
                    name: 'IJR', 
                    fullName: 'iShares Core S&P Small-Cap ETF', 
                    expenseRatio: 0.06, 
                    type: 'US Small Cap',
                    provider: 'iShares',
                    dividendYield: 1.3,
                    taxEfficiency: 'Very Good',
                    turnover: 14
                },
                iemg: { 
                    name: 'IEMG', 
                    fullName: 'iShares Core MSCI Emerging Markets ETF', 
                    expenseRatio: 0.09, 
                    type: 'Emerging Markets',
                    provider: 'iShares',
                    dividendYield: 3.6,
                    taxEfficiency: 'Good',
                    turnover: 10
                },
                
                // SPDR (State Street)
                spy: { 
                    name: 'SPY', 
                    fullName: 'SPDR S&P 500 ETF Trust', 
                    expenseRatio: 0.09, 
                    type: 'US Large Cap',
                    provider: 'SPDR',
                    dividendYield: 1.5,
                    taxEfficiency: 'Excellent',
                    turnover: 3
                },
                sptm: { 
                    name: 'SPTM', 
                    fullName: 'SPDR Portfolio S&P 1500 Composite Stock Market ETF', 
                    expenseRatio: 0.03, 
                    type: 'US Total Market',
                    provider: 'SPDR',
                    dividendYield: 1.4,
                    taxEfficiency: 'Excellent',
                    turnover: 4
                },
                spem: { 
                    name: 'SPEM', 
                    fullName: 'SPDR Portfolio Emerging Markets ETF', 
                    expenseRatio: 0.07, 
                    type: 'Emerging Markets',
                    provider: 'SPDR',
                    dividendYield: 3.7,
                    taxEfficiency: 'Good',
                    turnover: 11
                },
                
                // Bond ETFs
                bnd: { 
                    name: 'BND', 
                    fullName: 'Vanguard Total Bond Market ETF', 
                    expenseRatio: 0.03, 
                    type: 'US Bonds',
                    provider: 'Vanguard',
                    dividendYield: 4.2,
                    taxEfficiency: 'Excellent',
                    turnover: 10
                },
                agg: { 
                    name: 'AGG', 
                    fullName: 'iShares Core US Aggregate Bond ETF', 
                    expenseRatio: 0.03, 
                    type: 'US Bonds',
                    provider: 'iShares',
                    dividendYield: 4.1,
                    taxEfficiency: 'Excellent',
                    turnover: 9
                },
                bndw: { 
                    name: 'BNDW', 
                    fullName: 'Vanguard Total World Bond ETF', 
                    expenseRatio: 0.05, 
                    type: 'Global Bonds',
                    provider: 'Vanguard',
                    dividendYield: 4.0,
                    taxEfficiency: 'Very Good',
                    turnover: 11
                }
            };

            // Guided portfolio options
            const guidedPortfolios = [
                { 
                    name: '3-Fund Balanced', 
                    funds: [
                        { ticker: 'VTI', allocation: 'us' },
                        { ticker: 'VXUS', allocation: 'international' },
                        { ticker: 'BND', allocation: 'bonds' }
                    ],
                    description: 'Classic 3-fund with bonds (age-based)',
                    complexity: '3 funds',
                    hasBonds: true
                },
                { 
                    name: '3-Fund Conservative', 
                    funds: [
                        { ticker: 'VOO', allocation: 'us' },
                        { ticker: 'VXUS', allocation: 'international' },
                        { ticker: 'BND', allocation: 'bonds' }
                    ],
                    description: 'S&P 500 with bonds for stability',
                    complexity: '3 funds',
                    hasBonds: true
                },
                { 
                    name: 'Simple Two-Fund', 
                    funds: [
                        { ticker: 'VTI', allocation: 'us' },
                        { ticker: 'VXUS', allocation: 'international' }
                    ],
                    description: 'Classic & clean - total market coverage',
                    complexity: 'Simplest'
                },
                { 
                    name: 'S&P 500 Focus', 
                    funds: [
                        { ticker: 'VOO', allocation: 'us' },
                        { ticker: 'VXUS', allocation: 'international' }
                    ],
                    description: 'Large-cap US companies',
                    complexity: 'Simplest'
                },
                { 
                    name: 'Small-Cap Tilt', 
                    funds: [
                        { ticker: 'VOO', allocation: 'us', weight: 0.8 },
                        { ticker: 'VB', allocation: 'us', weight: 0.2 },
                        { ticker: 'VXUS', allocation: 'international' }
                    ],
                    description: '80/20 large/small cap US split',
                    complexity: '3 funds'
                },
                { 
                    name: 'Emerging Markets Split', 
                    funds: [
                        { ticker: 'VTI', allocation: 'us' },
                        { ticker: 'VEA', allocation: 'international', weight: 0.6 },
                        { ticker: 'VWO', allocation: 'international', weight: 0.4 }
                    ],
                    description: 'Separate developed & emerging intl',
                    complexity: '3 funds'
                }
            ];

            const [selectedPortfolio, setSelectedPortfolio] = useState(0);
            
            // Auto-adjust bond allocation when switching to/from 3-fund portfolios
            useEffect(() => {
                if (mode === 'guided' && guidedPortfolios[selectedPortfolio].hasBonds && bondAllocation === 0) {
                    setBondAllocation(recommendedBondAllocation);
                } else if (mode === 'guided' && !guidedPortfolios[selectedPortfolio].hasBonds) {
                    setBondAllocation(0);
                }
            }, [selectedPortfolio, mode]);
            
            // Auto-update bond allocation when age changes (but allow manual override)
            useEffect(() => {
                // Only auto-update if we have a valid age
                if (age && !isNaN(age) && age >= 18 && age <= 100) {
                    setBondAllocation(recommendedBondAllocation);
                }
            }, [age]); // Watches age changes
            
            // Custom mode state
            const [customFunds, setCustomFunds] = useState([
                { ticker: 'VTI', allocation: 70 },
                { ticker: 'VXUS', allocation: 30 }
            ]);

            // Calculate allocations based on mode
            const getCurrentFunds = () => {
                if (mode === 'guided') {
                    const portfolio = guidedPortfolios[selectedPortfolio];
                    const usAmount = (investmentAmount * usAllocation) / 100;
                    const intAmount = (investmentAmount * internationalAllocation) / 100;
                    const bondsAmount = (investmentAmount * bondAllocation) / 100;
                    
                    return portfolio.funds.map(fund => {
                        const etf = etfs[fund.ticker.toLowerCase()];
                        let baseAmount;
                        if (fund.allocation === 'us') {
                            baseAmount = usAmount;
                        } else if (fund.allocation === 'international') {
                            baseAmount = intAmount;
                        } else if (fund.allocation === 'bonds') {
                            baseAmount = bondsAmount;
                        }
                        const weight = fund.weight || 1;
                        const amount = baseAmount * weight;
                        const cost = amount * (etf.expenseRatio / 100);
                        
                        return {
                            ...etf,
                            ticker: fund.ticker,
                            amount,
                            cost,
                            percentage: (amount / investmentAmount) * 100
                        };
                    });
                } else if (mode === 'rebalance') {
                    // Rebalance mode - return current holdings
                    return currentHoldings.filter(h => h.amount > 0).map(holding => {
                        const totalValue = currentHoldings.reduce((sum, h) => sum + (h.amount || 0), 0);
                        if (holding.type === 'etf') {
                            const etf = etfs[holding.ticker.toLowerCase()];
                            return {
                                ...etf,
                                ticker: holding.ticker,
                                amount: holding.amount,
                                cost: holding.amount * ((etf?.expenseRatio || 0) / 100),
                                percentage: (holding.amount / totalValue) * 100,
                                type: 'etf'
                            };
                        } else {
                            // Stock
                            return {
                                ticker: holding.ticker,
                                fullName: holding.ticker + ' (Individual Stock)',
                                provider: 'Stock',
                                expenseRatio: 0,
                                dividendYield: 0,
                                taxEfficiency: 'Variable',
                                turnover: 0,
                                amount: holding.amount,
                                cost: 0,
                                percentage: (holding.amount / totalValue) * 100,
                                type: 'stock'
                            };
                        }
                    });
                } else {
                    // Custom mode
                    return customFunds.map(fund => {
                        const etf = etfs[fund.ticker.toLowerCase()];
                        const amount = (investmentAmount * fund.allocation) / 100;
                        const cost = amount * (etf.expenseRatio / 100);
                        
                        return {
                            ...etf,
                            ticker: fund.ticker,
                            amount,
                            cost,
                            percentage: fund.allocation
                        };
                    });
                }
            };

            const fundAllocations = getCurrentFunds();
            
            // Calculate the total portfolio value based on mode
            const totalPortfolioValue = mode === 'rebalance' 
                ? currentHoldings.reduce((sum, h) => sum + (h.amount || 0), 0)
                : investmentAmount;

            // Calculate totals
            const totalCost = fundAllocations.reduce((sum, fund) => sum + fund.cost, 0);
            const weightedExpenseRatio = totalPortfolioValue > 0 
                ? fundAllocations.reduce((sum, fund) => sum + (fund.amount * fund.expenseRatio), 0) / totalPortfolioValue
                : fundAllocations.reduce((sum, fund) => sum + fund.expenseRatio, 0) / fundAllocations.length;

            // Calculate growth projections with DCA
            const calculateGrowth = (returnRate) => {
                const years = [];
                const values = [];
                const costImpact = [];
                const totalContributions = [];
                const dividendIncome = [];
                
                // Calculate weighted average dividend yield
                const weightedDividendYield = totalPortfolioValue > 0 
                    ? fundAllocations.reduce((sum, fund) => sum + ((fund.amount / totalPortfolioValue) * fund.dividendYield), 0)
                    : fundAllocations.reduce((sum, fund) => sum + fund.dividendYield, 0) / fundAllocations.length;
                
                // Convert contribution frequency to number of periods per year
                const periodsPerYear = contributionFrequency === 'daily' ? 252 :      // Business days (Mon-Fri)
                                     contributionFrequency === 'weekly' ? 52 : 
                                     contributionFrequency === 'monthly' ? 12 : 
                                     contributionFrequency === 'quarterly' ? 4 : 1;
                const contributionPerPeriod = recurringContribution;
                
                for (let year = 0; year <= timeHorizon; year++) {
                    years.push(year);
                    
                    let portfolioValue = totalPortfolioValue;
                    let portfolioValueNoFees = totalPortfolioValue;
                    let totalInvested = totalPortfolioValue;
                    let yearlyDividends = 0;
                    
                    const netReturn = (returnRate - weightedExpenseRatio) / 100;
                    const grossReturn = returnRate / 100;
                    
                    // Calculate compound interest with regular contributions
                    for (let period = 1; period <= year * periodsPerYear; period++) {
                        // Add contribution at the beginning of each period
                        portfolioValue += contributionPerPeriod;
                        portfolioValueNoFees += contributionPerPeriod;
                        totalInvested += contributionPerPeriod;
                        
                        // Apply return for the period (annual rate / periods per year)
                        portfolioValue *= (1 + netReturn / periodsPerYear);
                        portfolioValueNoFees *= (1 + grossReturn / periodsPerYear);
                    }
                    
                    // Calculate dividends for the year (estimate based on average portfolio value)
                    if (year > 0) {
                        const avgPortfolioValue = (values[year - 1] + portfolioValue) / 2;
                        yearlyDividends = avgPortfolioValue * (weightedDividendYield / 100);
                    }
                    
                    // If year 0, just use initial investment
                    if (year === 0) {
                        portfolioValue = totalPortfolioValue;
                        portfolioValueNoFees = totalPortfolioValue;
                        totalInvested = totalPortfolioValue;
                        yearlyDividends = totalPortfolioValue * (weightedDividendYield / 100);
                    }
                    
                    values.push(portfolioValue);
                    costImpact.push(portfolioValueNoFees - portfolioValue);
                    totalContributions.push(totalInvested);
                    dividendIncome.push(yearlyDividends);
                }
                
                return { years, values, costImpact, totalContributions, dividendIncome, weightedDividendYield };
            };

            // Calculate growth for all 4 scenarios
            const growthDataConservative = calculateGrowth(scenarios.conservative);
            const growthDataExpected = calculateGrowth(scenarios.expected);
            const growthDataOptimistic = calculateGrowth(scenarios.optimistic);
            const growthDataCrisis = calculateGrowth(scenarios.crisis);
            
            // Use expected scenario as the main data source (for compatibility)
            const growthData = growthDataExpected;
            const finalValue = growthData.values[growthData.values.length - 1];
            const totalContributed = growthData.totalContributions[growthData.totalContributions.length - 1];
            const totalReturn = finalValue - totalContributed;
            const totalFeesLost = growthData.costImpact[growthData.costImpact.length - 1];
            const totalDividends = growthData.dividendIncome.reduce((sum, val) => sum + val, 0);
            const capitalGains = totalReturn - totalDividends;
            
            // Calculate financial advisor cost (1% annual fee on AUM vs low-cost ETFs)
            const advisorFeeRate = 1.0; // 1% annual fee typical for financial advisors
            const calculateAdvisorCost = () => {
                // Calculate portfolio WITH 1% advisor fee deducted each year
                // Advisor charges 1% of portfolio value annually (taken from assets)
                const grossReturn = scenarios.expected / 100; // Convert to decimal
                const etfExpenseRatio = weightedExpenseRatio / 100;
                
                const periodsPerYear = contributionFrequency === 'daily' ? 252 :
                                     contributionFrequency === 'weekly' ? 52 :
                                     contributionFrequency === 'monthly' ? 12 :
                                     contributionFrequency === 'quarterly' ? 4 : 1;
                
                let portfolioValueAdvisor = mode === 'rebalance' ? totalPortfolioValue : investmentAmount;
                
                // If no valid starting value, return 0
                if (portfolioValueAdvisor <= 0) return 0;
                
                for (let year = 0; year < timeHorizon; year++) {
                    // Add contributions and grow the portfolio each period
                    for (let period = 1; period <= periodsPerYear; period++) {
                        portfolioValueAdvisor += recurringContribution;
                        // Grow at gross return minus ETF expenses (advisor invests in same ETFs)
                        portfolioValueAdvisor *= (1 + (grossReturn - etfExpenseRatio) / periodsPerYear);
                    }
                    // At end of year, advisor takes their 1% fee from the portfolio value
                    portfolioValueAdvisor *= (1 - (advisorFeeRate / 100));
                }
                
                // Compare to our low-cost ETF portfolio
                // finalValue should always be >= portfolioValueAdvisor (self-managing is better)
                // The difference is how much the advisor COSTS you
                const advisorFeeLost = Math.max(0, finalValue - portfolioValueAdvisor);
                return advisorFeeLost;
            };
            
            const totalAdvisorFeesLost = calculateAdvisorCost();
            
            // Calculate historical crisis scenarios
            const calculateHistoricalCrisis = (annualReturns) => {
                // annualReturns is an array of returns for each year
                let portfolioValue = investmentAmount;
                let totalInvested = investmentAmount;
                
                const periodsPerYear = contributionFrequency === 'daily' ? 252 :
                                     contributionFrequency === 'weekly' ? 52 :
                                     contributionFrequency === 'monthly' ? 12 :
                                     contributionFrequency === 'quarterly' ? 4 : 1;
                
                for (let year = 0; year < annualReturns.length && year < timeHorizon; year++) {
                    const returnRate = annualReturns[year] / 100;
                    const netReturn = (annualReturns[year] - weightedExpenseRatio) / 100;
                    
                    for (let period = 1; period <= periodsPerYear; period++) {
                        portfolioValue += recurringContribution;
                        totalInvested += recurringContribution;
                        portfolioValue *= (1 + netReturn / periodsPerYear);
                    }
                }
                
                // Fill remaining years with expected return if crisis is shorter than time horizon
                for (let year = annualReturns.length; year < timeHorizon; year++) {
                    const netReturn = (scenarios.expected - weightedExpenseRatio) / 100;
                    for (let period = 1; period <= periodsPerYear; period++) {
                        portfolioValue += recurringContribution;
                        totalInvested += recurringContribution;
                        portfolioValue *= (1 + netReturn / periodsPerYear);
                    }
                }
                
                return { finalValue: portfolioValue, totalInvested };
            };
            
            // Model specific historical crises
            const crisis2008 = calculateHistoricalCrisis([-37, 26, 15, 2, 16, 32, 14, 12, 21, 29]); // 2008-2017 S&P 500 actual
            const crisisDotCom = calculateHistoricalCrisis([-9, -12, -22, 29, 11, 5, 16, 16, -37, 26]); // 2000-2009 actual
            const crisisDepression = calculateHistoricalCrisis([-43, -25, -9, -43, 50, 47, 32, -35, 31, 0]); // 1929-1938 modeled
            
            // Calculate "what-if" scenarios
            const calculateWhatIf = (usImpact, intlImpact, bondImpact) => {
                // Impact is percentage loss (e.g., -60 for 60% loss)
                const usLoss = (usAllocation / 100) * (usImpact / 100) * investmentAmount;
                const intlLoss = (internationalAllocation / 100) * (intlImpact / 100) * investmentAmount;
                const bondLoss = (bondAllocation / 100) * (bondImpact / 100) * investmentAmount;
                const immediateImpact = usLoss + intlLoss + bondLoss;
                
                // Calculate remaining value after crisis, then grow at expected rate
                const startingValue = investmentAmount + immediateImpact; // immediateImpact is negative
                const netReturn = (scenarios.expected - weightedExpenseRatio) / 100;
                
                const periodsPerYear = contributionFrequency === 'daily' ? 252 :
                                     contributionFrequency === 'weekly' ? 52 :
                                     contributionFrequency === 'monthly' ? 12 :
                                     contributionFrequency === 'quarterly' ? 4 : 1;
                
                let portfolioValue = startingValue;
                let totalInvested = investmentAmount;
                
                for (let year = 0; year < timeHorizon; year++) {
                    for (let period = 1; period <= periodsPerYear; period++) {
                        portfolioValue += recurringContribution;
                        totalInvested += recurringContribution;
                        portfolioValue *= (1 + netReturn / periodsPerYear);
                    }
                }
                
                return { 
                    finalValue: portfolioValue, 
                    totalInvested,
                    immediateImpact,
                    impactPercent: (immediateImpact / investmentAmount) * 100
                };
            };
            
            const whatIfSmallCap = calculateWhatIf(-60, 0, 0); // Small-cap wipeout
            const whatIfBondCrisis = calculateWhatIf(0, 0, -20); // Bond crisis (rates spike)
            const whatIfIntlCollapse = calculateWhatIf(0, -100, 0); // International collapse
            const whatIfArmageddon = calculateWhatIf(-60, -100, -20); // All three at once
            
            // Calculate cash/inflation comparison
            const cashScenario = calculateGrowth(0); // 0% return
            const inflationLoss = calculateGrowth(-3); // -3% real return (losing to inflation)

            // Find lowest fee portfolio for comparison
            const getLowestFeePortfolio = () => {
                let lowestFee = Infinity;
                let lowestIndex = 0;
                
                guidedPortfolios.forEach((portfolio, index) => {
                    const usAmount = (investmentAmount * usAllocation) / 100;
                    const intAmount = (investmentAmount * internationalAllocation) / 100;
                    
                    const fee = portfolio.funds.reduce((sum, fund) => {
                        const etf = etfs[fund.ticker.toLowerCase()];
                        const baseAmount = fund.allocation === 'us' ? usAmount : intAmount;
                        const weight = fund.weight || 1;
                        const amount = baseAmount * weight;
                        return sum + (amount * etf.expenseRatio);
                    }, 0) / investmentAmount;
                    
                    if (fee < lowestFee) {
                        lowestFee = fee;
                        lowestIndex = index;
                    }
                });
                
                return { lowestFee, lowestIndex };
            };

            const { lowestFee, lowestIndex } = mode === 'guided' ? getLowestFeePortfolio() : { lowestFee: null, lowestIndex: null };

            // Data for pie chart
            const colors = ['#3b82f6', '#6366f1', '#10b981', '#059669', '#f59e0b', '#ef4444'];

            // Create/update allocation chart
            useEffect(() => {
                if (chartRef.current) {
                    const ctx = chartRef.current.getContext('2d');
                    
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }

                    // Only create chart if there's money to show
                    if (investmentAmount > 0) {
                        chartInstance.current = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: fundAllocations.map(fund => fund.ticker),
                                datasets: [{
                                    data: fundAllocations.map(fund => fund.amount),
                                    backgroundColor: colors.slice(0, fundAllocations.length),
                                    borderWidth: 2,
                                    borderColor: '#ffffff'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            padding: 15,
                                            font: { size: 12 }
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const label = context.label || '';
                                                const value = context.parsed || 0;
                                                return label + ': $' + value.toLocaleString('en-US', { 
                                                    minimumFractionDigits: 2, 
                                                    maximumFractionDigits: 2 
                                                });
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                }

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [fundAllocations, investmentAmount]);

            // Create/update growth chart
            useEffect(() => {
                if (growthChartRef.current) {
                    const ctx = growthChartRef.current.getContext('2d');
                    
                    if (growthChartInstance.current) {
                        growthChartInstance.current.destroy();
                    }

                    growthChartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: growthData.years,
                            datasets: [
                                {
                                    label: '🚀 Optimistic (' + scenarios.optimistic.toFixed(1) + '%)',
                                    data: growthDataOptimistic.values,
                                    borderColor: '#10b981',
                                    backgroundColor: 'rgba(16, 185, 129, 0.05)',
                                    fill: false,
                                    tension: 0.4,
                                    borderWidth: 2,
                                    borderDash: [5, 5]
                                },
                                {
                                    label: '🎯 Expected (' + scenarios.expected.toFixed(1) + '%)',
                                    data: growthDataExpected.values,
                                    borderColor: '#3b82f6',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    fill: true,
                                    tension: 0.4,
                                    borderWidth: 3
                                },
                                {
                                    label: '🐢 Conservative (' + scenarios.conservative.toFixed(1) + '%)',
                                    data: growthDataConservative.values,
                                    borderColor: '#f97316',
                                    backgroundColor: 'rgba(249, 115, 22, 0.05)',
                                    fill: false,
                                    tension: 0.4,
                                    borderWidth: 2,
                                    borderDash: [5, 5]
                                },
                                {
                                    label: '💥 Market Crisis (' + scenarios.crisis.toFixed(1) + '%)',
                                    data: growthDataCrisis.values,
                                    borderColor: '#dc2626',
                                    backgroundColor: 'rgba(220, 38, 38, 0.05)',
                                    fill: false,
                                    tension: 0.4,
                                    borderWidth: 2,
                                    borderDash: [10, 5]
                                },
                                {
                                    label: 'Total Contributions',
                                    data: growthData.totalContributions,
                                    borderColor: '#6b7280',
                                    backgroundColor: 'rgba(107, 114, 128, 0.05)',
                                    fill: false,
                                    tension: 0.4,
                                    borderDash: [2, 2],
                                    borderWidth: 1.5
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': $' + context.parsed.y.toLocaleString('en-US', { 
                                                minimumFractionDigits: 0, 
                                                maximumFractionDigits: 0 
                                            });
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    ticks: {
                                        callback: function(value) {
                                            if (value >= 1000000) {
                                                return '$' + (value / 1000000).toFixed(1) + 'M';
                                            } else if (value >= 1000) {
                                                return '$' + (value / 1000).toFixed(0) + 'k';
                                            } else {
                                                return '$' + value.toFixed(0);
                                            }
                                        }
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Years'
                                    }
                                }
                            }
                        }
                    });
                }

                return () => {
                    if (growthChartInstance.current) {
                        growthChartInstance.current.destroy();
                    }
                };
            }, [growthData, scenarios.conservative, scenarios.expected, scenarios.optimistic, timeHorizon, recurringContribution, contributionFrequency, fundAllocations]);

            const addCustomFund = () => {
                const availableFunds = Object.keys(etfs).filter(
                    key => !customFunds.some(f => f.ticker.toLowerCase() === key)
                );
                if (availableFunds.length > 0) {
                    setCustomFunds([...customFunds, { 
                        ticker: availableFunds[0].toUpperCase(), 
                        allocation: 0 
                    }]);
                }
            };

            const removeCustomFund = (index) => {
                if (customFunds.length > 1) {
                    setCustomFunds(customFunds.filter((_, i) => i !== index));
                }
            };

            const updateCustomFund = (index, field, value) => {
                const updated = [...customFunds];
                updated[index][field] = value;
                setCustomFunds(updated);
            };

            const normalizeAllocations = () => {
                const numFunds = customFunds.length;
                const baseAllocation = Math.floor(100 / numFunds);
                const remainder = 100 - (baseAllocation * numFunds);
                
                // Distribute evenly, giving remainder to first fund(s)
                const normalized = customFunds.map((fund, index) => ({
                    ...fund,
                    allocation: baseAllocation + (index < remainder ? 1 : 0)
                }));
                
                setCustomFunds(normalized);
            };

            const generatePDF = async () => {
                setIsGeneratingPDF(true);
                
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pageWidth = 210;
                    const pageHeight = 297;
                    const margin = 20;
                    let yPos = 0;
                    
                    // Helper function to add colored box
                    const addColoredBox = (x, y, width, height, fillColor, borderColor) => {
                        pdf.setFillColor(fillColor[0], fillColor[1], fillColor[2]);
                        pdf.setDrawColor(borderColor[0], borderColor[1], borderColor[2]);
                        pdf.setLineWidth(0.5);
                        pdf.roundedRect(x, y, width, height, 2, 2, 'FD');
                    };
                    
                    // Helper to check if we need a new page
                    const checkNewPage = (spaceNeeded) => {
                        if (yPos + spaceNeeded > pageHeight - margin) {
                            pdf.addPage();
                            yPos = margin;
                            return true;
                        }
                        return false;
                    };
                    
                    // PAGE 1: Header and Summary
                    pdf.setFillColor(59, 130, 246);
                    pdf.rect(0, 0, pageWidth, 50, 'F');
                    
                    pdf.setFontSize(24);
                    pdf.setTextColor(255, 255, 255);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Investment Allocation Report', pageWidth / 2, 25, { align: 'center' });
                    
                    pdf.setFontSize(11);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text('Generated: ' + new Date().toLocaleDateString(), pageWidth / 2, 35, { align: 'center' });
                    
                    yPos = 60;
                    
                    // Portfolio Summary
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFontSize(14);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('PORTFOLIO SUMMARY', margin, yPos);
                    yPos += 8;
                    
                    addColoredBox(margin, yPos, pageWidth - 2 * margin, 32, [239, 246, 255], [191, 219, 254]);
                    
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(30, 30, 30);
                    yPos += 8;
                    pdf.text('Mode: ' + (mode === 'guided' ? 'Guided Portfolio' : 'Custom Mix'), margin + 5, yPos);
                    yPos += 6;
                    pdf.text('Initial Investment: $' + investmentAmount.toLocaleString('en-US'), margin + 5, yPos);
                    yPos += 6;
                    if (recurringContribution > 0) {
                        pdf.text('Recurring: $' + recurringContribution.toLocaleString('en-US') + ' (' + contributionFrequency + ')', margin + 5, yPos);
                        yPos += 6;
                    }
                    pdf.text('Time Horizon: ' + timeHorizon + ' years | Expected Return: ' + scenarios.expected.toFixed(1) + '% (Range: ' + scenarios.conservative.toFixed(1) + '%-' + scenarios.optimistic.toFixed(1) + '%)', margin + 5, yPos);
                    yPos += 12;
                    
                    // Fund Allocations
                    pdf.setFontSize(14);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(0, 0, 0);
                    pdf.text('FUND ALLOCATIONS', margin, yPos);
                    yPos += 8;
                    
                    const colors = [
                        { fill: [239, 246, 255], border: [191, 219, 254], text: [59, 130, 246] },
                        { fill: [243, 244, 246], border: [209, 213, 219], text: [99, 102, 241] },
                        { fill: [236, 253, 245], border: [167, 243, 208], text: [16, 185, 129] },
                        { fill: [240, 253, 244], border: [167, 243, 208], text: [5, 150, 105] },
                        { fill: [254, 252, 232], border: [253, 224, 71], text: [245, 158, 11] },
                        { fill: [254, 242, 242], border: [254, 202, 202], text: [239, 68, 68] }
                    ];
                    
                    fundAllocations.forEach((fund, index) => {
                        checkNewPage(35);
                        
                        const color = colors[index % colors.length];
                        addColoredBox(margin, yPos, pageWidth - 2 * margin, 28, color.fill, color.border);
                        
                        pdf.setFontSize(11);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(color.text[0], color.text[1], color.text[2]);
                        pdf.text(fund.ticker, margin + 5, yPos + 7);
                        
                        pdf.setFont('helvetica', 'normal');
                        pdf.setTextColor(60, 60, 60);
                        pdf.setFontSize(9);
                        pdf.text(fund.fullName, margin + 25, yPos + 7);
                        
                        // Provider
                        pdf.setFillColor(255, 255, 255);
                        pdf.roundedRect(pageWidth - margin - 25, yPos + 4, 20, 5, 1, 1, 'F');
                        pdf.setFontSize(8);
                        pdf.setTextColor(80, 80, 80);
                        pdf.text(fund.provider, pageWidth - margin - 15, yPos + 7, { align: 'center' });
                        
                        pdf.setFontSize(13);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(0, 0, 0);
                        pdf.text('$' + fund.amount.toLocaleString('en-US', { minimumFractionDigits: 2 }), margin + 5, yPos + 15);
                        
                        pdf.setFontSize(10);
                        pdf.setFont('helvetica', 'normal');
                        pdf.setTextColor(100, 100, 100);
                        pdf.text('(' + fund.percentage.toFixed(1) + '%)', margin + 50, yPos + 15);
                        
                        pdf.setFontSize(8);
                        pdf.setTextColor(80, 80, 80);
                        pdf.text('Fee: ' + fund.expenseRatio + '% | Yield: ' + fund.dividendYield + '% | Tax: ' + fund.taxEfficiency + ' | Turnover: ' + fund.turnover + '%', margin + 5, yPos + 22);
                        
                        yPos += 33;
                    });
                    
                    // Cost Analysis
                    checkNewPage(40);
                    pdf.setFontSize(14);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(0, 0, 0);
                    pdf.text('COST ANALYSIS', margin, yPos);
                    yPos += 8;
                    
                    const boxWidth = (pageWidth - 2 * margin - 10) / 3;
                    
                    addColoredBox(margin, yPos, boxWidth, 22, [239, 246, 255], [147, 197, 253]);
                    pdf.setFontSize(8);
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('Weighted Expense Ratio', margin + boxWidth / 2, yPos + 7, { align: 'center' });
                    pdf.setFontSize(16);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(59, 130, 246);
                    pdf.text(weightedExpenseRatio.toFixed(3) + '%', margin + boxWidth / 2, yPos + 16, { align: 'center' });
                    
                    addColoredBox(margin + boxWidth + 5, yPos, boxWidth, 22, [254, 249, 195], [253, 224, 71]);
                    pdf.setFontSize(8);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('Annual Cost', margin + boxWidth + 5 + boxWidth / 2, yPos + 7, { align: 'center' });
                    pdf.setFontSize(16);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(245, 158, 11);
                    pdf.text('$' + totalCost.toLocaleString('en-US', { minimumFractionDigits: 0 }), margin + boxWidth + 5 + boxWidth / 2, yPos + 16, { align: 'center' });
                    
                    addColoredBox(margin + 2 * boxWidth + 10, yPos, boxWidth, 22, [254, 242, 242], [252, 165, 165]);
                    pdf.setFontSize(8);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('Fees Lost (' + timeHorizon + 'Y)', margin + 2 * boxWidth + 10 + boxWidth / 2, yPos + 7, { align: 'center' });
                    pdf.setFontSize(16);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(239, 68, 68);
                    pdf.text('$' + totalFeesLost.toLocaleString('en-US', { minimumFractionDigits: 0 }), margin + 2 * boxWidth + 10 + boxWidth / 2, yPos + 16, { align: 'center' });
                    
                    yPos += 28;
                    
                    // Financial Advisor Comparison
                    addColoredBox(margin, yPos, pageWidth - 2 * margin, 28, [254, 242, 242], [252, 165, 165]);
                    pdf.setFontSize(9);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(153, 27, 27);
                    pdf.text('Cost of 1% Financial Advisor Fee', margin + 5, yPos + 7);
                    pdf.setFontSize(18);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(220, 38, 38);
                    pdf.text('$' + totalAdvisorFeesLost.toLocaleString('en-US', { minimumFractionDigits: 0 }), margin + 5, yPos + 18);
                    pdf.setFontSize(7);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(127, 29, 29);
                    pdf.text('Additional cost vs. self-managing these ETFs', margin + 5, yPos + 23);
                    
                    yPos += 32;
                    
                    // PAGE 2: Growth Projection
                    pdf.addPage();
                    yPos = margin;
                    
                    pdf.setFontSize(14);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(0, 0, 0);
                    pdf.text('GROWTH PROJECTION', margin, yPos);
                    yPos += 8;
                    
                    const growthBoxWidth = (pageWidth - 2 * margin - 15) / 4;
                    
                    addColoredBox(margin, yPos, growthBoxWidth, 22, [239, 246, 255], [147, 197, 253]);
                    pdf.setFontSize(7);
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('Total Invested', margin + growthBoxWidth / 2, yPos + 6, { align: 'center' });
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(30, 30, 30);
                    pdf.text('$' + totalContributed.toLocaleString('en-US', { minimumFractionDigits: 0 }), margin + growthBoxWidth / 2, yPos + 15, { align: 'center' });
                    
                    addColoredBox(margin + growthBoxWidth + 5, yPos, growthBoxWidth, 22, [236, 253, 245], [134, 239, 172]);
                    pdf.setFontSize(7);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('Value (' + timeHorizon + 'Y)', margin + growthBoxWidth + 5 + growthBoxWidth / 2, yPos + 6, { align: 'center' });
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(16, 185, 129);
                    pdf.text('$' + finalValue.toLocaleString('en-US', { minimumFractionDigits: 0 }), margin + growthBoxWidth + 5 + growthBoxWidth / 2, yPos + 15, { align: 'center' });
                    
                    addColoredBox(margin + 2 * growthBoxWidth + 10, yPos, growthBoxWidth, 22, [243, 232, 255], [196, 181, 253]);
                    pdf.setFontSize(7);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('Growth', margin + 2 * growthBoxWidth + 10 + growthBoxWidth / 2, yPos + 6, { align: 'center' });
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(147, 51, 234);
                    pdf.text('$' + totalReturn.toLocaleString('en-US', { minimumFractionDigits: 0 }), margin + 2 * growthBoxWidth + 10 + growthBoxWidth / 2, yPos + 15, { align: 'center' });
                    
                    addColoredBox(margin + 3 * growthBoxWidth + 15, yPos, growthBoxWidth, 22, [224, 231, 255], [165, 180, 252]);
                    pdf.setFontSize(7);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('Return', margin + 3 * growthBoxWidth + 15 + growthBoxWidth / 2, yPos + 6, { align: 'center' });
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(79, 70, 229);
                    if (totalContributed > 0) {
                        pdf.text(((totalReturn / totalContributed) * 100).toFixed(1) + '%', margin + 3 * growthBoxWidth + 15 + growthBoxWidth / 2, yPos + 15, { align: 'center' });
                    } else {
                        pdf.text('N/A', margin + 3 * growthBoxWidth + 15 + growthBoxWidth / 2, yPos + 15, { align: 'center' });
                    }
                    
                    yPos += 30;
                    
                    // Earnings Breakdown
                    pdf.setFontSize(14);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(0, 0, 0);
                    pdf.text('EARNINGS BREAKDOWN', margin, yPos);
                    yPos += 8;
                    
                    const earningsBoxWidth = (pageWidth - 2 * margin - 10) / 3;
                    
                    addColoredBox(margin, yPos, earningsBoxWidth, 25, [240, 253, 250], [153, 246, 228]);
                    pdf.setFontSize(8);
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('Dividend Income', margin + earningsBoxWidth / 2, yPos + 6, { align: 'center' });
                    pdf.setFontSize(13);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(20, 184, 166);
                    pdf.text('$' + totalDividends.toLocaleString('en-US', { minimumFractionDigits: 0 }), margin + earningsBoxWidth / 2, yPos + 15, { align: 'center' });
                    pdf.setFontSize(7);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(80, 80, 80);
                    pdf.text('Avg ' + growthData.weightedDividendYield.toFixed(2) + '% yield', margin + earningsBoxWidth / 2, yPos + 20, { align: 'center' });
                    
                    addColoredBox(margin + earningsBoxWidth + 5, yPos, earningsBoxWidth, 25, [254, 243, 199], [253, 230, 138]);
                    pdf.setFontSize(8);
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('Capital Gains', margin + earningsBoxWidth + 5 + earningsBoxWidth / 2, yPos + 6, { align: 'center' });
                    pdf.setFontSize(13);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(217, 119, 6);
                    pdf.text('$' + capitalGains.toLocaleString('en-US', { minimumFractionDigits: 0 }), margin + earningsBoxWidth + 5 + earningsBoxWidth / 2, yPos + 15, { align: 'center' });
                    if (totalReturn > 0) {
                        pdf.setFontSize(7);
                        pdf.setFont('helvetica', 'normal');
                        pdf.setTextColor(80, 80, 80);
                        pdf.text(((capitalGains / totalReturn) * 100).toFixed(1) + '% of growth', margin + earningsBoxWidth + 5 + earningsBoxWidth / 2, yPos + 20, { align: 'center' });
                    }
                    
                    addColoredBox(margin + 2 * earningsBoxWidth + 10, yPos, earningsBoxWidth, 25, [254, 242, 242], [254, 202, 202]);
                    pdf.setFontSize(8);
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('Last Year Income', margin + 2 * earningsBoxWidth + 10 + earningsBoxWidth / 2, yPos + 6, { align: 'center' });
                    pdf.setFontSize(13);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(220, 38, 38);
                    pdf.text('$' + growthData.dividendIncome[growthData.dividendIncome.length - 1].toLocaleString('en-US', { minimumFractionDigits: 0 }), margin + 2 * earningsBoxWidth + 10 + earningsBoxWidth / 2, yPos + 15, { align: 'center' });
                    pdf.setFontSize(7);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(80, 80, 80);
                    pdf.text('Annual (Year ' + timeHorizon + ')', margin + 2 * earningsBoxWidth + 10 + earningsBoxWidth / 2, yPos + 20, { align: 'center' });
                    
                    yPos += 35;
                    
                    // Stress Test & Crisis Scenarios
                    pdf.addPage();
                    yPos = margin;
                    
                    pdf.setFontSize(14);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(0, 0, 0);
                    pdf.text('STRESS TEST & CRISIS SCENARIOS', margin, yPos);
                    yPos += 8;
                    
                    // Helper to format values
                    const formatValue = (val) => {
                        if (val >= 1000000) {
                            return '$' + (val / 1000000).toFixed(1) + 'M';
                        } else {
                            return '$' + (val / 1000).toFixed(0) + 'K';
                        }
                    };
                    
                    // 2008 Financial Crisis
                    addColoredBox(margin, yPos, pageWidth - 2 * margin, 28, [254, 242, 242], [254, 202, 202]);
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(153, 27, 27);
                    pdf.text('2008 Financial Crisis', margin + 5, yPos + 7);
                    pdf.setFontSize(8);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(60, 60, 60);
                    pdf.text('Year 1: -37% crash, then gradual recovery (actual S&P 500 returns 2008-2017)', margin + 5, yPos + 13);
                    pdf.setFontSize(11);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(185, 28, 28);
                    pdf.text('Final Value: ' + formatValue(crisis2008.finalValue), margin + 5, yPos + 21);
                    pdf.setFontSize(8);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(21, 128, 61);
                    pdf.text('Still grew: ' + formatValue(crisis2008.finalValue - crisis2008.totalInvested), margin + 70, yPos + 21);
                    
                    yPos += 32;
                    
                    // Dot-com Crash
                    addColoredBox(margin, yPos, pageWidth - 2 * margin, 28, [250, 245, 255], [221, 214, 254]);
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(107, 33, 168);
                    pdf.text('Dot-com Crash (2000-2002)', margin + 5, yPos + 7);
                    pdf.setFontSize(8);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(60, 60, 60);
                    pdf.text('3 years of losses (-43% cumulative), then recovery (actual 2000-2009)', margin + 5, yPos + 13);
                    pdf.setFontSize(11);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(107, 33, 168);
                    pdf.text('Final Value: ' + formatValue(crisisDotCom.finalValue), margin + 5, yPos + 21);
                    pdf.setFontSize(8);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(21, 128, 61);
                    pdf.text('Still grew: ' + formatValue(crisisDotCom.finalValue - crisisDotCom.totalInvested), margin + 70, yPos + 21);
                    
                    yPos += 32;
                    
                    // Great Depression
                    addColoredBox(margin, yPos, pageWidth - 2 * margin, 28, [243, 244, 246], [209, 213, 219]);
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(55, 65, 81);
                    pdf.text('Great Depression Style (1929-1933)', margin + 5, yPos + 7);
                    pdf.setFontSize(8);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(60, 60, 60);
                    pdf.text('4 years catastrophic losses (-80% total), then slow recovery. Worst-case scenario.', margin + 5, yPos + 13);
                    pdf.setFontSize(11);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(55, 65, 81);
                    pdf.text('Final Value: ' + formatValue(crisisDepression.finalValue), margin + 5, yPos + 21);
                    
                    yPos += 32;
                    
                    // Key Takeaway
                    addColoredBox(margin, yPos, pageWidth - 2 * margin, 25, [236, 253, 245], [134, 239, 172]);
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(21, 128, 61);
                    pdf.text('Key Takeaway', margin + 5, yPos + 7);
                    pdf.setFontSize(8);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(22, 101, 52);
                    const takeaway = 'Even through the worst historical market crashes, staying invested and continuing contributions resulted in portfolio growth. Time in the market beats timing the market.';
                    const splitTakeaway = pdf.splitTextToSize(takeaway, pageWidth - 2 * margin - 10);
                    pdf.text(splitTakeaway, margin + 5, yPos + 14);
                    
                    yPos += 35;
                    
                    // What-If Scenarios
                    checkNewPage(120);
                    
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(0, 0, 0);
                    pdf.text('What-If Scenarios', margin, yPos);
                    yPos += 6;
                    
                    // Small-Cap Wipeout
                    addColoredBox(margin, yPos, pageWidth - 2 * margin, 22, [254, 243, 199], [252, 211, 77]);
                    pdf.setFontSize(9);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(146, 64, 14);
                    pdf.text('Small-Cap Wipeout (-60%)', margin + 5, yPos + 7);
                    pdf.setFontSize(7);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(60, 60, 60);
                    pdf.text('Impact: ' + whatIfSmallCap.impactPercent.toFixed(1) + '% loss | Final: ' + formatValue(whatIfSmallCap.finalValue), margin + 5, yPos + 14);
                    
                    yPos += 24;
                    
                    // Bond Crisis
                    addColoredBox(margin, yPos, pageWidth - 2 * margin, 22, [254, 242, 242], [254, 202, 202]);
                    pdf.setFontSize(9);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(153, 27, 27);
                    pdf.text('Bond Crisis (-20%)', margin + 5, yPos + 7);
                    pdf.setFontSize(7);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(60, 60, 60);
                    pdf.text('Impact: ' + whatIfBondCrisis.impactPercent.toFixed(1) + '% loss | Final: ' + formatValue(whatIfBondCrisis.finalValue), margin + 5, yPos + 14);
                    
                    yPos += 24;
                    
                    // International Collapse
                    addColoredBox(margin, yPos, pageWidth - 2 * margin, 22, [224, 231, 255], [165, 180, 252]);
                    pdf.setFontSize(9);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(67, 56, 202);
                    pdf.text('International Markets Collapse (-100%)', margin + 5, yPos + 7);
                    pdf.setFontSize(7);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(60, 60, 60);
                    pdf.text('Impact: ' + whatIfIntlCollapse.impactPercent.toFixed(1) + '% loss | Final: ' + formatValue(whatIfIntlCollapse.finalValue), margin + 5, yPos + 14);
                    
                    yPos += 24;
                    
                    // Market Armageddon
                    addColoredBox(margin, yPos, pageWidth - 2 * margin, 22, [254, 215, 170], [251, 146, 60]);
                    pdf.setFontSize(9);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(154, 52, 18);
                    pdf.text('Market Armageddon (Everything Collapses)', margin + 5, yPos + 7);
                    pdf.setFontSize(7);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(60, 60, 60);
                    pdf.text('Impact: ' + whatIfArmageddon.impactPercent.toFixed(1) + '% loss | Final: ' + formatValue(whatIfArmageddon.finalValue), margin + 5, yPos + 14);
                    
                    yPos += 30;
                    
                    // vs. Cash/Inflation
                    checkNewPage(90);
                    
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(0, 0, 0);
                    pdf.text('vs. Cash & Inflation', margin, yPos);
                    yPos += 8;
                    
                    const compBoxWidth = (pageWidth - 2 * margin - 10) / 3;
                    
                    // Crisis Portfolio
                    addColoredBox(margin, yPos, compBoxWidth, 28, [239, 246, 255], [147, 197, 253]);
                    pdf.setFontSize(8);
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('Your Portfolio', margin + compBoxWidth / 2, yPos + 6, { align: 'center' });
                    pdf.text('(Crisis Scenario)', margin + compBoxWidth / 2, yPos + 11, { align: 'center' });
                    pdf.setFontSize(11);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(59, 130, 246);
                    const crisisVal = growthDataCrisis.values[growthDataCrisis.values.length - 1];
                    pdf.text(formatValue(crisisVal), margin + compBoxWidth / 2, yPos + 20, { align: 'center' });
                    
                    // Cash
                    addColoredBox(margin + compBoxWidth + 5, yPos, compBoxWidth, 28, [243, 244, 246], [209, 213, 219]);
                    pdf.setFontSize(8);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('Cash', margin + compBoxWidth + 5 + compBoxWidth / 2, yPos + 6, { align: 'center' });
                    pdf.text('(0% Return)', margin + compBoxWidth + 5 + compBoxWidth / 2, yPos + 11, { align: 'center' });
                    pdf.setFontSize(11);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(107, 114, 128);
                    const cashVal = cashScenario.values[cashScenario.values.length - 1];
                    pdf.text(formatValue(cashVal), margin + compBoxWidth + 5 + compBoxWidth / 2, yPos + 20, { align: 'center' });
                    
                    // Inflation Loss
                    addColoredBox(margin + 2 * compBoxWidth + 10, yPos, compBoxWidth, 28, [254, 242, 242], [254, 202, 202]);
                    pdf.setFontSize(8);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('Losing to Inflation', margin + 2 * compBoxWidth + 10 + compBoxWidth / 2, yPos + 6, { align: 'center' });
                    pdf.text('(-3% Real)', margin + 2 * compBoxWidth + 10 + compBoxWidth / 2, yPos + 11, { align: 'center' });
                    pdf.setFontSize(11);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(220, 38, 38);
                    const inflationVal = inflationLoss.values[inflationLoss.values.length - 1];
                    pdf.text(formatValue(inflationVal), margin + 2 * compBoxWidth + 10 + compBoxWidth / 2, yPos + 20, { align: 'center' });
                    
                    yPos += 32;
                    
                    // Bottom line comparison
                    addColoredBox(margin, yPos, pageWidth - 2 * margin, 20, [236, 253, 245], [134, 239, 172]);
                    pdf.setFontSize(8);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(21, 128, 61);
                    pdf.text('The Bottom Line: Even in a crisis, staying invested beats cash', margin + 5, yPos + 7);
                    pdf.setFontSize(7);
                    pdf.setFont('helvetica', 'normal');
                    const cashDiff = crisisVal - cashVal;
                    const inflationDiff = crisisVal - inflationVal;
                    pdf.text('vs. Cash: +' + formatValue(cashDiff) + ' better | vs. Inflation: +' + formatValue(inflationDiff) + ' better', margin + 5, yPos + 14);
                    
                    yPos += 30;
                    
                    // Charts - with proper waiting for render
                    if (growthChartRef.current) {
                        try {
                            // Wait a bit for chart to be fully rendered
                            await new Promise(resolve => setTimeout(resolve, 500));
                            
                            const chartContainer = growthChartRef.current.parentElement;
                            const canvas = await html2canvas(chartContainer, {
                                scale: 2,
                                backgroundColor: '#ffffff',
                                logging: false,
                                useCORS: true
                            });
                            
                            if (canvas && canvas.width > 0 && canvas.height > 0) {
                                const imgData = canvas.toDataURL('image/png');
                                pdf.addPage();
                                yPos = margin;
                                pdf.setFontSize(14);
                                pdf.setFont('helvetica', 'bold');
                                pdf.setTextColor(0, 0, 0);
                                pdf.text('Growth Projection Chart', margin, yPos);
                                yPos += 10;
                                pdf.addImage(imgData, 'PNG', margin, yPos, pageWidth - 2 * margin, 100);
                                yPos += 110;
                            }
                        } catch (err) {
                            console.log('Could not capture growth chart:', err);
                        }
                    }
                    
                    if (chartRef.current && investmentAmount > 0) {
                        try {
                            await new Promise(resolve => setTimeout(resolve, 500));
                            
                            const chartContainer = chartRef.current.parentElement;
                            const canvas = await html2canvas(chartContainer, {
                                scale: 2,
                                backgroundColor: '#ffffff',
                                logging: false,
                                useCORS: true
                            });
                            
                            if (canvas && canvas.width > 0 && canvas.height > 0) {
                                const imgData = canvas.toDataURL('image/png');
                                
                                if (!growthChartRef.current || yPos < margin + 20) {
                                    pdf.addPage();
                                    yPos = margin;
                                }
                                
                                checkNewPage(90);
                                pdf.setFontSize(14);
                                pdf.setFont('helvetica', 'bold');
                                pdf.setTextColor(0, 0, 0);
                                pdf.text('Portfolio Allocation Chart', margin, yPos);
                                yPos += 10;
                                pdf.addImage(imgData, 'PNG', margin, yPos, pageWidth - 2 * margin, 80);
                            }
                        } catch (err) {
                            console.log('Could not capture allocation chart:', err);
                        }
                    }
                    
                    // Disclaimer
                    pdf.addPage();
                    yPos = margin;
                    
                    addColoredBox(margin, yPos, pageWidth - 2 * margin, 55, [254, 252, 232], [250, 204, 21]);
                    
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(133, 77, 14);
                    pdf.text('IMPORTANT DISCLAIMER', margin + 5, yPos + 10);
                    
                    pdf.setFontSize(9);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(60, 60, 60);
                    const disclaimer = 'This report is for educational purposes only. Projections are based on assumptions and past performance does not guarantee future results. Investment values can go down as well as up. Tax treatment depends on your individual situation and may change in the future. The expense ratios, dividend yields, and tax efficiency ratings shown are estimates based on current data and may change. This is not financial advice. Consider consulting a qualified financial advisor and tax professional for personalized guidance based on your specific circumstances.';
                    const splitDisclaimer = pdf.splitTextToSize(disclaimer, pageWidth - 2 * margin - 10);
                    pdf.text(splitDisclaimer, margin + 5, yPos + 20);
                    
                    // Footer
                    pdf.setFontSize(8);
                    pdf.setTextColor(150, 150, 150);
                    pdf.text('Generated by Investment Allocation Calculator', pageWidth / 2, pageHeight - 10, { align: 'center' });
                    
                    // Save
                    pdf.save('investment-allocation-report.pdf');
                    
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('Error generating PDF. Please try again.');
                } finally {
                    setIsGeneratingPDF(false);
                }
            };

            const sendEmailReport = async () => {
                if (!userEmail || !userEmail.includes('@')) {
                    alert('Please enter a valid email address');
                    return;
                }
                
                // Check if EmailJS is loaded
                if (typeof emailjs === 'undefined') {
                    alert('Email service is not loaded. Please refresh the page and try again.');
                    console.error('EmailJS library not loaded');
                    return;
                }
                
                setIsSendingEmail(true);
                
                try {
                    // Initialize EmailJS (do this once)
                    emailjs.init(EMAILJS_PUBLIC_KEY);
                    
                    console.log('Sending email to:', userEmail);
                    console.log('Using service:', EMAILJS_SERVICE_ID);
                    console.log('Using template:', EMAILJS_TEMPLATE_ID_USER);
                    
                    // Create email body with summary
                    const reportContent = `Investment Allocation Report
Generated: ${new Date().toLocaleDateString()}

PORTFOLIO SUMMARY:
- Mode: ${mode === 'guided' ? 'Guided Portfolio' : 'Custom Mix'}
- Initial Investment: $${investmentAmount.toLocaleString('en-US')}
${recurringContribution > 0 ? `- Recurring: $${recurringContribution.toLocaleString('en-US')} (${contributionFrequency})` : ''}
- Time Horizon: ${timeHorizon} years
- Age: ${age}
- Expected Return: ${scenarios.expected.toFixed(1)}% (Conservative: ${scenarios.conservative.toFixed(1)}%, Optimistic: ${scenarios.optimistic.toFixed(1)}%)

FUND ALLOCATIONS:
${fundAllocations.map(fund => 
    `${fund.ticker} (${fund.provider}): $${fund.amount.toLocaleString('en-US', { minimumFractionDigits: 2 })} (${fund.percentage.toFixed(1)}%)
    Fee: ${fund.expenseRatio}% | Yield: ${fund.dividendYield}% | Tax: ${fund.taxEfficiency}`
).join('\n\n')}

COST ANALYSIS:
- Weighted Expense Ratio: ${weightedExpenseRatio.toFixed(3)}%
- Annual Cost: $${totalCost.toLocaleString('en-US', { minimumFractionDigits: 2 })}
- Fees Lost (${timeHorizon} years): $${totalFeesLost.toLocaleString('en-US', { minimumFractionDigits: 0 })}
- Cost of 1% Financial Advisor Fee: $${totalAdvisorFeesLost.toLocaleString('en-US', { minimumFractionDigits: 0 })} (additional vs. self-managing)

GROWTH PROJECTION:
- Total Invested: $${totalContributed.toLocaleString('en-US', { minimumFractionDigits: 0 })}
- Projected Value: $${finalValue.toLocaleString('en-US', { minimumFractionDigits: 0 })}
- Investment Growth: $${totalReturn.toLocaleString('en-US', { minimumFractionDigits: 0 })}
${totalContributed > 0 ? `- Return: ${((totalReturn / totalContributed) * 100).toFixed(1)}%` : ''}

EARNINGS BREAKDOWN:
- Dividend Income: $${totalDividends.toLocaleString('en-US', { minimumFractionDigits: 0 })}
- Capital Gains: $${capitalGains.toLocaleString('en-US', { minimumFractionDigits: 0 })}
- Avg Yield: ${growthData.weightedDividendYield.toFixed(2)}%

STRESS TEST & CRISIS SCENARIOS:

Historical Crises:
- 2008 Financial Crisis: Final value ${(crisis2008.finalValue >= 1000000 ? '$' + (crisis2008.finalValue / 1000000).toFixed(1) + 'M' : '$' + (crisis2008.finalValue / 1000).toFixed(0) + 'K')} (still grew!)
- Dot-com Crash (2000-2002): Final value ${(crisisDotCom.finalValue >= 1000000 ? '$' + (crisisDotCom.finalValue / 1000000).toFixed(1) + 'M' : '$' + (crisisDotCom.finalValue / 1000).toFixed(0) + 'K')} (still grew!)
- Great Depression Style: Final value ${(crisisDepression.finalValue >= 1000000 ? '$' + (crisisDepression.finalValue / 1000000).toFixed(1) + 'M' : '$' + (crisisDepression.finalValue / 1000).toFixed(0) + 'K')}

What-If Scenarios:
- Small-Cap Wipeout (-60%): Impact ${whatIfSmallCap.impactPercent.toFixed(1)}% | Final ${(whatIfSmallCap.finalValue >= 1000000 ? '$' + (whatIfSmallCap.finalValue / 1000000).toFixed(1) + 'M' : '$' + (whatIfSmallCap.finalValue / 1000).toFixed(0) + 'K')}
- Bond Crisis (-20%): Impact ${whatIfBondCrisis.impactPercent.toFixed(1)}% | Final ${(whatIfBondCrisis.finalValue >= 1000000 ? '$' + (whatIfBondCrisis.finalValue / 1000000).toFixed(1) + 'M' : '$' + (whatIfBondCrisis.finalValue / 1000).toFixed(0) + 'K')}
- International Collapse (-100%): Impact ${whatIfIntlCollapse.impactPercent.toFixed(1)}% | Final ${(whatIfIntlCollapse.finalValue >= 1000000 ? '$' + (whatIfIntlCollapse.finalValue / 1000000).toFixed(1) + 'M' : '$' + (whatIfIntlCollapse.finalValue / 1000).toFixed(0) + 'K')}
- Market Armageddon: Impact ${whatIfArmageddon.impactPercent.toFixed(1)}% | Final ${(whatIfArmageddon.finalValue >= 1000000 ? '$' + (whatIfArmageddon.finalValue / 1000000).toFixed(1) + 'M' : '$' + (whatIfArmageddon.finalValue / 1000).toFixed(0) + 'K')}

vs. Cash & Inflation:
- Crisis Portfolio: ${(() => { const val = growthDataCrisis.values[growthDataCrisis.values.length - 1]; return val >= 1000000 ? '$' + (val / 1000000).toFixed(1) + 'M' : '$' + (val / 1000).toFixed(0) + 'K'; })()}
- Cash (0% return): ${(() => { const val = cashScenario.values[cashScenario.values.length - 1]; return val >= 1000000 ? '$' + (val / 1000000).toFixed(1) + 'M' : '$' + (val / 1000).toFixed(0) + 'K'; })()}
- Inflation Loss: ${(() => { const val = inflationLoss.values[inflationLoss.values.length - 1]; return val >= 1000000 ? '$' + (val / 1000000).toFixed(1) + 'M' : '$' + (val / 1000).toFixed(0) + 'K'; })()}

---
This report is for educational purposes only. Past performance does not guarantee future results.
Consult a financial advisor for personalized advice.`;

                    // Send email to user
                    const userEmailParams = {
                        to_email: userEmail,
                        to_name: 'Investor',
                        report_content: reportContent
                    };
                    
                    await emailjs.send(
                        EMAILJS_SERVICE_ID,
                        EMAILJS_TEMPLATE_ID_USER,
                        userEmailParams
                    );
                    
                    // Send notification to owner with user's data
                    const ownerEmailParams = {
                        to_email: OWNER_EMAIL,
                        user_email: userEmail,
                        user_age: age,
                        mode: mode === 'guided' ? 'Guided Portfolio' : 'Custom Mix',
                        investment_amount: investmentAmount.toLocaleString('en-US'),
                        recurring_contribution: recurringContribution.toLocaleString('en-US'),
                        contribution_frequency: contributionFrequency,
                        time_horizon: timeHorizon,
                        final_value: finalValue.toLocaleString('en-US'),
                        us_allocation: usAllocation,
                        international_allocation: internationalAllocation,
                        bond_allocation: bondAllocation,
                        report_content: reportContent
                    };
                    
                    await emailjs.send(
                        EMAILJS_SERVICE_ID,
                        EMAILJS_TEMPLATE_ID_OWNER,
                        ownerEmailParams
                    );
                    
                    // Log to Google Sheets if configured
                    if (GOOGLE_SHEETS_URL && GOOGLE_SHEETS_URL !== 'YOUR_GOOGLE_SCRIPT_URL') {
                        try {
                            const sheetsData = {
                                email: userEmail,
                                age: age,
                                mode: mode === 'guided' ? 'Guided Portfolio' : 'Custom Mix',
                                investmentAmount: investmentAmount,
                                recurringContribution: recurringContribution,
                                contributionFrequency: contributionFrequency,
                                timeHorizon: timeHorizon,
                                usAllocation: usAllocation,
                                internationalAllocation: internationalAllocation,
                                bondAllocation: bondAllocation,
                                expectedReturn: scenarios.expected,
                                finalValue: finalValue,
                                totalInvested: totalContributed,
                                totalReturn: totalReturn,
                                expenseRatio: weightedExpenseRatio,
                                annualCost: totalCost,
                                feesLost: totalFeesLost,
                                advisorFeeCost: totalAdvisorFeesLost
                            };
                            
                            await fetch(GOOGLE_SHEETS_URL, {
                                method: 'POST',
                                mode: 'no-cors',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(sheetsData)
                            });
                            
                            console.log('Data logged to Google Sheets');
                        } catch (sheetsError) {
                            console.error('Failed to log to Google Sheets:', sheetsError);
                            // Don't fail the whole process if sheets logging fails
                        }
                    }
                    
                    alert('✅ Report sent successfully! Check your email inbox.');
                    
                } catch (error) {
                    console.error('Full error details:', error);
                    console.error('Error status:', error.status);
                    console.error('Error text:', error.text);
                    
                    // More detailed error message
                    let errorMsg = '❌ Failed to send email.\n\n';
                    
                    if (error.status === 400) {
                        errorMsg += 'Error: Invalid template or parameters.\n';
                        errorMsg += 'Please check that your EmailJS templates are set up correctly.\n\n';
                    } else if (error.status === 403) {
                        errorMsg += 'Error: Unauthorized. Check your EmailJS public key.\n\n';
                    } else if (error.status === 422) {
                        errorMsg += 'Error: Template variables don\'t match.\n';
                        errorMsg += 'Make sure your templates have the correct {{variable}} names.\n\n';
                    } else if (error.text) {
                        errorMsg += 'Error: ' + error.text + '\n\n';
                    }
                    
                    errorMsg += 'Check the browser console (F12) for detailed error information.\n';
                    errorMsg += 'Or contact hello@slowlabs.co for help.';
                    
                    alert(errorMsg);
                } finally {
                    setIsSendingEmail(false);
                }
            };

            const totalCustomAllocation = customFunds.reduce((sum, fund) => sum + fund.allocation, 0);

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4 md:p-8">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <div className="bg-white rounded-2xl shadow-xl p-6 md:p-8 mb-6">
                            <div className="flex items-center gap-3 mb-2">
                                <TrendingUp className="w-8 h-8 text-blue-600" />
                                <h1 className="text-2xl md:text-3xl font-bold text-gray-800">Investment Allocation Calculator</h1>
                            </div>
                            <p className="text-gray-600 mb-6">Low-cost index fund portfolio builder with growth projections</p>

                            {/* Mode Selector */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
                                <button
                                    onClick={() => setMode('guided')}
                                    className={`p-4 rounded-lg border-2 transition-all ${
                                        mode === 'guided'
                                            ? 'border-blue-500 bg-blue-50'
                                            : 'border-gray-300 hover:border-gray-400'
                                    }`}
                                >
                                    <div className="flex items-center justify-center gap-2 mb-2">
                                        <Sparkles className="w-5 h-5" />
                                        <span className="font-semibold">Starting Fresh</span>
                                    </div>
                                    <p className="text-sm text-gray-600">Build a portfolio from scratch</p>
                                </button>
                                <button
                                    onClick={() => setMode('custom')}
                                    className={`p-4 rounded-lg border-2 transition-all ${
                                        mode === 'custom'
                                            ? 'border-blue-500 bg-blue-50'
                                            : 'border-gray-300 hover:border-gray-400'
                                    }`}
                                >
                                    <div className="flex items-center justify-center gap-2 mb-2">
                                        <Sliders className="w-5 h-5" />
                                        <span className="font-semibold">Custom Mix</span>
                                    </div>
                                    <p className="text-sm text-gray-600">Choose specific ETFs</p>
                                </button>
                                <button
                                    onClick={() => setMode('rebalance')}
                                    className={`p-4 rounded-lg border-2 transition-all ${
                                        mode === 'rebalance'
                                            ? 'border-green-500 bg-green-50'
                                            : 'border-gray-300 hover:border-gray-400'
                                    }`}
                                >
                                    <div className="flex items-center justify-center gap-2 mb-2">
                                        <TrendingUp className="w-5 h-5" />
                                        <span className="font-semibold">Analyze & Rebalance</span>
                                    </div>
                                    <p className="text-sm text-gray-600">I have existing investments</p>
                                </button>
                            </div>

                            {/* Investment Amount Input */}
                            {mode !== 'rebalance' && (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            <DollarSign className="inline w-4 h-4 mr-1" />
                                            Initial Investment (Optional - can be $0)
                                        </label>
                                        <input
                                            type="number"
                                            value={investmentAmount}
                                            onChange={(e) => {
                                                const value = e.target.value;
                                                if (value === '') {
                                                    setInvestmentAmount(0);
                                                } else {
                                                    setInvestmentAmount(Number(value));
                                                }
                                            }}
                                            onBlur={(e) => {
                                                const value = Number(e.target.value);
                                                if (value < 0) setInvestmentAmount(0);
                                            }}
                                            className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg font-semibold focus:border-blue-500 focus:outline-none"
                                            min="0"
                                            step="1000"
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            👤 Your Current Age
                                        </label>
                                        <input
                                            type="number"
                                            value={age}
                                            onChange={(e) => {
                                                const value = e.target.value;
                                                // Allow empty string or any number while typing
                                                if (value === '') {
                                                    setAge('');
                                                } else if (!isNaN(Number(value))) {
                                                    setAge(Number(value));
                                                }
                                            }}
                                            onBlur={(e) => {
                                                const value = e.target.value;
                                                // On blur, ensure we have a valid number between 18-100
                                                if (value === '' || isNaN(Number(value)) || Number(value) < 18) {
                                                    setAge(30); // Default to 30 if invalid or too young
                                                } else if (Number(value) > 100) {
                                                    setAge(100); // Cap at 100
                                                }
                                            }}
                                            className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg font-semibold focus:border-blue-500 focus:outline-none"
                                            min="18"
                                            max="100"
                                            placeholder="30"
                                        />
                                        <p className="text-xs text-gray-500 mt-1">
                                            Helps suggest bond allocation (Rule of {age < 50 ? '120' : '110'}: ~{recommendedBondAllocation}% bonds recommended)
                                        </p>
                                    </div>
                                </div>
                            )}

                            {mode === 'guided' ? (
                                <>
                                    {/* Portfolio Selection */}
                                    <div className="mb-6">
                                        <label className="block text-sm font-semibold text-gray-700 mb-3">
                                            Portfolio Strategy
                                        </label>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {guidedPortfolios.map((portfolio, index) => (
                                                <button
                                                    key={index}
                                                    onClick={() => setSelectedPortfolio(index)}
                                                    className={`p-4 rounded-lg border-2 transition-all text-left relative ${
                                                        selectedPortfolio === index
                                                            ? 'border-blue-500 bg-blue-50'
                                                            : 'border-gray-300 hover:border-gray-400'
                                                    }`}
                                                >
                                                    {index === lowestIndex && (
                                                        <div className="absolute -top-2 -right-2 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-full">
                                                            LOWEST FEES
                                                        </div>
                                                    )}
                                                    <div className="flex justify-between items-start mb-1">
                                                        <div className="font-semibold text-gray-800">{portfolio.name}</div>
                                                        <span className="text-xs bg-gray-200 px-2 py-1 rounded">{portfolio.complexity}</span>
                                                    </div>
                                                    <div className="text-sm text-gray-600 mb-2">{portfolio.description}</div>
                                                    <div className="text-xs text-gray-500">
                                                        {portfolio.funds.map(f => f.ticker).join(' + ')}
                                                    </div>
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Allocation Slider */}
                                    <div className="mb-6">
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            <Percent className="inline w-4 h-4 mr-1" />
                                            US / International Split {guidedPortfolios[selectedPortfolio].hasBonds && `(${stockAllocation}% stocks)`}
                                        </label>
                                        <div className="flex items-center gap-4">
                                            <span className="text-sm font-medium text-blue-600 w-16">{usAllocation}% US</span>
                                            <input
                                                type="range"
                                                min="0"
                                                max={stockAllocation}
                                                value={usAllocation}
                                                onChange={(e) => setUsAllocation(Number(e.target.value))}
                                                className="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                            />
                                            <span className="text-sm font-medium text-green-600 w-24">{internationalAllocation}% Intl</span>
                                        </div>
                                    </div>
                                    
                                    {/* Bond Allocation Slider (shows for 3-fund portfolios) */}
                                    {guidedPortfolios[selectedPortfolio].hasBonds && (
                                        <div className="mb-6 bg-amber-50 border-2 border-amber-200 rounded-lg p-4">
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                🏛️ Bond Allocation
                                            </label>
                                            <div className="flex items-center gap-4 mb-2">
                                                <span className="text-sm font-medium text-amber-700 w-20">{bondAllocation}% Bonds</span>
                                                <input
                                                    type="range"
                                                    min="0"
                                                    max="80"
                                                    value={bondAllocation}
                                                    onChange={(e) => setBondAllocation(Number(e.target.value))}
                                                    className="flex-1 h-2 bg-amber-200 rounded-lg appearance-none cursor-pointer"
                                                />
                                                <span className="text-sm font-medium text-blue-600 w-24">{stockAllocation}% Stocks</span>
                                            </div>
                                            <div className="flex justify-between items-center text-xs">
                                                <span className="text-gray-600">
                                                    Recommended for age {age}: <span className="font-semibold text-amber-700">{recommendedBondAllocation}%</span>
                                                </span>
                                                <button
                                                    onClick={() => setBondAllocation(recommendedBondAllocation)}
                                                    className="text-blue-600 hover:text-blue-700 font-medium underline"
                                                >
                                                    Use recommended
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </>
                            ) : mode === 'custom' ? (
                                <>
                                    {/* Custom Fund Selection */}
                                    <div className="mb-6">
                                        <label className="block text-sm font-semibold text-gray-700 mb-3">
                                            Build Your Portfolio
                                        </label>
                                        <div className="mb-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                            <p className="text-sm text-blue-800">
                                                <span className="font-semibold">📚 20+ Low-Cost ETFs Available:</span> Choose from Vanguard, Schwab, iShares (BlackRock), and SPDR funds. All have expense ratios under 0.11% and excellent tax efficiency.
                                            </p>
                                        </div>
                                        <div className="space-y-3">
                                            {customFunds.map((fund, index) => {
                                                const selectedEtf = etfs[fund.ticker.toLowerCase()];
                                                return (
                                                    <div key={index} className="border-2 border-gray-200 rounded-lg p-3">
                                                        <div className="flex gap-3 items-start mb-2">
                                                            <select
                                                                value={fund.ticker}
                                                                onChange={(e) => updateCustomFund(index, 'ticker', e.target.value)}
                                                                className="flex-1 px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-sm"
                                                            >
                                                                <optgroup label="Vanguard ETFs">
                                                                    {Object.keys(etfs).filter(key => etfs[key].provider === 'Vanguard').map(key => (
                                                                        <option key={key} value={key.toUpperCase()}>
                                                                            {key.toUpperCase()} - {etfs[key].fullName} ({etfs[key].expenseRatio}%)
                                                                        </option>
                                                                    ))}
                                                                </optgroup>
                                                                <optgroup label="Schwab ETFs">
                                                                    {Object.keys(etfs).filter(key => etfs[key].provider === 'Schwab').map(key => (
                                                                        <option key={key} value={key.toUpperCase()}>
                                                                            {key.toUpperCase()} - {etfs[key].fullName} ({etfs[key].expenseRatio}%)
                                                                        </option>
                                                                    ))}
                                                                </optgroup>
                                                                <optgroup label="iShares ETFs (BlackRock)">
                                                                    {Object.keys(etfs).filter(key => etfs[key].provider === 'iShares').map(key => (
                                                                        <option key={key} value={key.toUpperCase()}>
                                                                            {key.toUpperCase()} - {etfs[key].fullName} ({etfs[key].expenseRatio}%)
                                                                        </option>
                                                                    ))}
                                                                </optgroup>
                                                                <optgroup label="SPDR ETFs (State Street)">
                                                                    {Object.keys(etfs).filter(key => etfs[key].provider === 'SPDR').map(key => (
                                                                        <option key={key} value={key.toUpperCase()}>
                                                                            {key.toUpperCase()} - {etfs[key].fullName} ({etfs[key].expenseRatio}%)
                                                                        </option>
                                                                    ))}
                                                                </optgroup>
                                                            </select>
                                                            <input
                                                                type="number"
                                                                value={fund.allocation}
                                                                onChange={(e) => updateCustomFund(index, 'allocation', Math.max(0, Math.min(100, Number(e.target.value))))}
                                                                className="w-24 px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-sm"
                                                                min="0"
                                                                max="100"
                                                            />
                                                            <span className="text-sm font-medium mt-2">%</span>
                                                            {customFunds.length > 1 && (
                                                                <button
                                                                    onClick={() => removeCustomFund(index)}
                                                                    className="px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-colors text-sm"
                                                                >
                                                                    Remove
                                                                </button>
                                                            )}
                                                        </div>
                                                        {selectedEtf && (
                                                            <div className="text-xs text-gray-600 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-2 bg-gray-50 p-2 rounded">
                                                                <div>
                                                                    <span className="font-semibold">Fee:</span> {selectedEtf.expenseRatio}%
                                                                </div>
                                                                <div>
                                                                    <span className="font-semibold">Yield:</span> {selectedEtf.dividendYield}%
                                                                </div>
                                                                <div>
                                                                    <span className="font-semibold">Tax:</span> {selectedEtf.taxEfficiency}
                                                                </div>
                                                                <div>
                                                                    <span className="font-semibold">Turnover:</span> {selectedEtf.turnover}%
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                        <div className="flex gap-3 mt-3">
                                            <button
                                                onClick={addCustomFund}
                                                disabled={customFunds.length >= Object.keys(etfs).length}
                                                className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                                            >
                                                Add Fund
                                            </button>
                                            {totalCustomAllocation !== 100 && (
                                                <button
                                                    onClick={normalizeAllocations}
                                                    className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors"
                                                >
                                                    Split Evenly (100%)
                                                </button>
                                            )}
                                        </div>
                                        {totalCustomAllocation !== 100 && (
                                            <p className="text-sm text-orange-600 mt-2">
                                                Total: {totalCustomAllocation}% (should equal 100%)
                                            </p>
                                        )}
                                    </div>
                                </>
                            ) : (
                                <>
                                    {/* Rebalance Mode - Analyze Current Holdings */}
                                    
                                    {/* Age for Rule of 110/120 */}
                                    <div className="mb-6">
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            Current Age (for allocation guidance)
                                        </label>
                                        <div className="flex items-center gap-4">
                                            <input
                                                type="number"
                                                value={age}
                                                onChange={(e) => {
                                                    const value = e.target.value;
                                                    // Allow empty string or any number while typing
                                                    if (value === '') {
                                                        setAge('');
                                                    } else if (!isNaN(Number(value))) {
                                                        setAge(Number(value));
                                                    }
                                                }}
                                                onBlur={(e) => {
                                                    const value = Number(e.target.value);
                                                    // On blur, clamp to valid range
                                                    if (!value || value < 18) setAge(18);
                                                    else if (value > 100) setAge(100);
                                                }}
                                                className="w-32 px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-lg font-semibold"
                                                min="18"
                                                max="100"
                                                placeholder="30"
                                            />
                                            <div className="text-sm text-gray-600">
                                                <span className="font-semibold">Rule of {age < 50 ? '120' : '110'}:</span> {age < 50 ? 120 - (age || 30) : 110 - (age || 30)}% stocks / {age < 50 ? (age || 30) - 20 : (age || 30) - 10}% bonds
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="mb-6">
                                        <label className="block text-sm font-semibold text-gray-700 mb-3">
                                            📊 Current Holdings
                                        </label>
                                        <div className="mb-3 p-3 bg-green-50 rounded-lg border border-green-200">
                                            <p className="text-sm text-green-800 mb-2">
                                                <span className="font-semibold">💡 Enter your current investments:</span> Add your existing ETFs and individual stocks with detailed information.
                                            </p>
                                            <ul className="text-xs text-green-700 space-y-1 ml-4">
                                                <li>• <strong>Shares & Price:</strong> We'll calculate total value automatically</li>
                                                <li>• <strong>Purchase Date:</strong> Shows tax holding period (long-term = held 1+ year = lower taxes)</li>
                                                <li>• <strong>Tax Efficiency:</strong> Long-term capital gains taxed at 0-20% vs. short-term at your income rate</li>
                                            </ul>
                                        </div>
                                        
                                        {/* Upload and Price Update Controls */}
                                        <div className="mb-4 flex gap-3 flex-wrap items-center">
                                            <label className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors cursor-pointer flex items-center gap-2">
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                                </svg>
                                                {isUploadingFile ? 'Uploading...' : 'Upload CSV'}
                                                <input
                                                    type="file"
                                                    accept=".csv"
                                                    onChange={handleCSVUpload}
                                                    className="hidden"
                                                    disabled={isUploadingFile}
                                                />
                                            </label>
                                            
                                            <button
                                                onClick={() => fetchRealTimePrices()}
                                                disabled={isFetchingPrices || currentHoldings.length === 0}
                                                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center gap-2"
                                            >
                                                <svg className={`w-5 h-5 ${isFetchingPrices ? 'animate-spin' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                                </svg>
                                                {isFetchingPrices ? 'Updating...' : 'Update Prices'}
                                            </button>
                                            
                                            {lastPriceUpdate && (
                                                <span className="text-xs text-gray-600">
                                                    Last updated: {lastPriceUpdate.toLocaleTimeString()}
                                                </span>
                                            )}
                                        </div>
                                        
                                        {/* CSV Format Help */}
                                        <details className="mb-4 text-sm">
                                            <summary className="cursor-pointer text-blue-600 hover:text-blue-700 font-semibold">
                                                📄 CSV Format Guide
                                            </summary>
                                            <div className="mt-2 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                                <p className="text-gray-700 mb-2">Your CSV should have these columns:</p>
                                                <code className="block bg-white p-2 rounded text-xs mb-2">
                                                    Ticker,Shares,Price,Type,PurchaseDate<br/>
                                                    AAPL,100,150.50,stock,2023-01-15<br/>
                                                    VOO,50,400.25,etf,2022-06-20
                                                </code>
                                                <ul className="text-xs text-gray-600 space-y-1 ml-4">
                                                    <li>• <strong>Required:</strong> Ticker, Shares, Price</li>
                                                    <li>• <strong>Optional:</strong> Type (etf/stock), PurchaseDate (YYYY-MM-DD)</li>
                                                    <li>• Column names are flexible (e.g., "Symbol" or "Ticker" both work)</li>
                                                </ul>
                                            </div>
                                        </details>
                                        
                                        <div className="space-y-3">
                                            {currentHoldings.map((holding, index) => {
                                                // Calculate tax holding period
                                                const calculateHoldingPeriod = (purchaseDate) => {
                                                    if (!purchaseDate) return null;
                                                    const purchase = new Date(purchaseDate);
                                                    const now = new Date();
                                                    const daysDiff = Math.floor((now - purchase) / (1000 * 60 * 60 * 24));
                                                    const isLongTerm = daysDiff >= 365;
                                                    return { days: daysDiff, isLongTerm };
                                                };
                                                
                                                const holdingPeriod = calculateHoldingPeriod(holding.purchaseDate);
                                                
                                                return (
                                                <div key={index} className="border-2 border-gray-200 rounded-lg p-4 bg-gray-50">
                                                    {/* First Row: Type and Ticker */}
                                                    <div className="flex gap-3 items-start mb-3">
                                                        <select
                                                            value={holding.type}
                                                            onChange={(e) => {
                                                                const newHoldings = [...currentHoldings];
                                                                newHoldings[index].type = e.target.value;
                                                                if (e.target.value === 'etf') {
                                                                    newHoldings[index].ticker = 'VOO';
                                                                } else {
                                                                    newHoldings[index].ticker = '';
                                                                }
                                                                setCurrentHoldings(newHoldings);
                                                            }}
                                                            className="w-28 px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-sm bg-white"
                                                        >
                                                            <option value="etf">ETF</option>
                                                            <option value="stock">Stock</option>
                                                        </select>
                                                        
                                                        {holding.type === 'etf' ? (
                                                            <select
                                                                value={holding.ticker}
                                                                onChange={(e) => {
                                                                    const newHoldings = [...currentHoldings];
                                                                    newHoldings[index].ticker = e.target.value;
                                                                    setCurrentHoldings(newHoldings);
                                                                }}
                                                                className="flex-1 px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-sm bg-white"
                                                            >
                                                                <optgroup label="Vanguard ETFs">
                                                                    {Object.keys(etfs).filter(key => etfs[key].provider === 'Vanguard').map(key => (
                                                                        <option key={key} value={key.toUpperCase()}>
                                                                            {key.toUpperCase()} - {etfs[key].fullName}
                                                                        </option>
                                                                    ))}
                                                                </optgroup>
                                                                <optgroup label="Schwab ETFs">
                                                                    {Object.keys(etfs).filter(key => etfs[key].provider === 'Schwab').map(key => (
                                                                        <option key={key} value={key.toUpperCase()}>
                                                                            {key.toUpperCase()} - {etfs[key].fullName}
                                                                        </option>
                                                                    ))}
                                                                </optgroup>
                                                                <optgroup label="iShares ETFs (BlackRock)">
                                                                    {Object.keys(etfs).filter(key => etfs[key].provider === 'iShares').map(key => (
                                                                        <option key={key} value={key.toUpperCase()}>
                                                                            {key.toUpperCase()} - {etfs[key].fullName}
                                                                        </option>
                                                                    ))}
                                                                </optgroup>
                                                                <optgroup label="SPDR ETFs (State Street)">
                                                                    {Object.keys(etfs).filter(key => etfs[key].provider === 'SPDR').map(key => (
                                                                        <option key={key} value={key.toUpperCase()}>
                                                                            {key.toUpperCase()} - {etfs[key].fullName}
                                                                        </option>
                                                                    ))}
                                                                </optgroup>
                                                            </select>
                                                        ) : (
                                                            <input
                                                                type="text"
                                                                value={holding.ticker}
                                                                onChange={(e) => {
                                                                    const newHoldings = [...currentHoldings];
                                                                    newHoldings[index].ticker = e.target.value.toUpperCase();
                                                                    setCurrentHoldings(newHoldings);
                                                                }}
                                                                placeholder="Ticker (e.g., AAPL)"
                                                                className="flex-1 px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-sm bg-white"
                                                            />
                                                        )}
                                                        
                                                        {currentHoldings.length > 1 && (
                                                            <button
                                                                onClick={() => {
                                                                    setCurrentHoldings(currentHoldings.filter((_, i) => i !== index));
                                                                }}
                                                                className="px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-colors text-sm font-semibold"
                                                            >
                                                                ✕
                                                            </button>
                                                        )}
                                                    </div>
                                                    
                                                    {/* Second Row: Shares, Price, Purchase Date */}
                                                    <div className="grid grid-cols-3 gap-3">
                                                        <div>
                                                            <label className="block text-xs text-gray-600 mb-1 font-semibold">Shares</label>
                                                            <input
                                                                type="number"
                                                                value={holding.shares || ''}
                                                                onChange={(e) => {
                                                                    const newHoldings = [...currentHoldings];
                                                                    const shares = Number(e.target.value);
                                                                    newHoldings[index].shares = shares;
                                                                    newHoldings[index].amount = shares * (holding.price || 0);
                                                                    setCurrentHoldings(newHoldings);
                                                                }}
                                                                placeholder="0"
                                                                className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-sm bg-white"
                                                                min="0"
                                                                step="0.001"
                                                            />
                                                        </div>
                                                        
                                                        <div>
                                                            <label className="block text-xs text-gray-600 mb-1 font-semibold">Price per Share</label>
                                                            <div className="flex gap-2">
                                                                <input
                                                                    type="number"
                                                                    value={holding.price || ''}
                                                                    onChange={(e) => {
                                                                        const newHoldings = [...currentHoldings];
                                                                        const price = Number(e.target.value);
                                                                        newHoldings[index].price = price;
                                                                        newHoldings[index].amount = (holding.shares || 0) * price;
                                                                        setCurrentHoldings(newHoldings);
                                                                    }}
                                                                    placeholder="$0.00"
                                                                    className="flex-1 px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-sm bg-white"
                                                                    min="0"
                                                                    step="0.01"
                                                                />
                                                                {holding.ticker && (
                                                                    <button
                                                                        onClick={async () => {
                                                                            if (!holding.ticker) {
                                                                                alert('Please enter a ticker symbol first');
                                                                                return;
                                                                            }
                                                                            
                                                                            // Show loading state
                                                                            const newHoldings = [...currentHoldings];
                                                                            newHoldings[index].isFetchingPrice = true;
                                                                            setCurrentHoldings(newHoldings);
                                                                            
                                                                            // Try to fetch price with fallback methods
                                                                            const result = await fetchPriceWithFallback(holding.ticker);
                                                                            
                                                                            const updatedHoldings = [...currentHoldings];
                                                                            updatedHoldings[index].isFetchingPrice = false;
                                                                            
                                                                            if (result.success) {
                                                                                updatedHoldings[index].price = result.price;
                                                                                updatedHoldings[index].amount = updatedHoldings[index].shares * result.price;
                                                                                setCurrentHoldings(updatedHoldings);
                                                                            } else {
                                                                                setCurrentHoldings(updatedHoldings);
                                                                                alert(`Could not fetch price for ${holding.ticker}.\n\nPossible reasons:\n• Ticker symbol is incorrect\n• Stock is not US-listed\n• Network/API issues\n\nPlease enter the price manually.`);
                                                                            }
                                                                        }}
                                                                        className="px-2 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-xs font-semibold whitespace-nowrap disabled:bg-gray-400"
                                                                        disabled={holding.isFetchingPrice}
                                                                        title="Fetch current market price"
                                                                    >
                                                                        {holding.isFetchingPrice ? '...' : '💲'}
                                                                    </button>
                                                                )}
                                                            </div>
                                                        </div>
                                                        
                                                        <div>
                                                            <label className="block text-xs text-gray-600 mb-1 font-semibold">Purchase Date</label>
                                                            <input
                                                                type="date"
                                                                value={holding.purchaseDate || ''}
                                                                onChange={(e) => {
                                                                    const newHoldings = [...currentHoldings];
                                                                    newHoldings[index].purchaseDate = e.target.value;
                                                                    setCurrentHoldings(newHoldings);
                                                                }}
                                                                className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-sm bg-white"
                                                            />
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Calculated Value Display */}
                                                    <div className="mt-3 pt-3 border-t border-gray-300">
                                                        <div className="flex justify-between items-center">
                                                            <span className="text-sm font-semibold text-gray-700">Total Value:</span>
                                                            <span className="text-lg font-bold text-green-600">
                                                                ${(holding.amount || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                                            </span>
                                                        </div>
                                                        {holdingPeriod && (
                                                            <div className="mt-2 flex items-center justify-between text-xs">
                                                                <span className="text-gray-600">
                                                                    Held for {Math.floor(holdingPeriod.days / 365)} years, {holdingPeriod.days % 365} days
                                                                </span>
                                                                <span className={`px-2 py-1 rounded font-semibold ${holdingPeriod.isLongTerm ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>
                                                                    {holdingPeriod.isLongTerm ? '✓ Long-term (lower tax)' : '⏳ Short-term (higher tax)'}
                                                                </span>
                                                            </div>
                                                        )}
                                                    </div>
                                                    
                                                    {holding.type === 'stock' && holding.ticker && (
                                                        <div className="text-xs text-orange-600 bg-orange-50 p-2 rounded mt-3">
                                                            ⚠️ <span className="font-semibold">Individual stock:</span> Consider diversifying into broad-market ETFs for lower risk
                                                        </div>
                                                    )}
                                                </div>
                                            )})}
                                        </div>
                                        
                                        <div className="flex gap-3 mt-3">
                                            <button
                                                onClick={() => setCurrentHoldings([...currentHoldings, { ticker: 'VOO', shares: 0, price: 0, amount: 0, type: 'etf', purchaseDate: '' }])}
                                                className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
                                            >
                                                Add Holding
                                            </button>
                                        </div>
                                        
                                        {/* Current Portfolio Summary */}
                                        {currentHoldings.some(h => h.amount > 0) && (
                                            <div className="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                                                <h4 className="font-semibold text-gray-800 mb-2">Current Portfolio Value</h4>
                                                <div className="text-3xl font-bold text-gray-900">
                                                    ${currentHoldings.reduce((sum, h) => sum + (h.amount || 0), 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                                </div>
                                                <div className="text-sm text-gray-600 mt-1">
                                                    {currentHoldings.filter(h => h.amount > 0).length} holdings
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Target Allocation Selection */}
                                    {currentHoldings.some(h => h.amount > 0) && (
                                        <>
                                        <div className="mb-6">
                                            <label className="block text-sm font-semibold text-gray-700 mb-3">
                                                🎯 Target Allocation
                                            </label>
                                            <div className="mb-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                                <p className="text-sm text-blue-800">
                                                    Choose your desired portfolio allocation to see how to rebalance
                                                </p>
                                            </div>
                                            
                                            {/* Portfolio Selection (reusing from guided mode) */}
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                {guidedPortfolios.map((portfolio, index) => (
                                                    <button
                                                        key={index}
                                                        onClick={() => setSelectedPortfolio(index)}
                                                        className={`p-4 rounded-lg border-2 transition-all text-left ${
                                                            selectedPortfolio === index
                                                                ? 'border-green-500 bg-green-50'
                                                                : 'border-gray-300 hover:border-gray-400'
                                                        }`}
                                                    >
                                                        <div className="flex justify-between items-start mb-1">
                                                            <div className="font-semibold text-gray-800">{portfolio.name}</div>
                                                            <span className="text-xs bg-gray-200 px-2 py-1 rounded">{portfolio.complexity}</span>
                                                        </div>
                                                        <div className="text-sm text-gray-600 mb-2">{portfolio.description}</div>
                                                        <div className="text-xs text-gray-500">
                                                            {portfolio.funds.map(f => f.ticker).join(' + ')}
                                                        </div>
                                                    </button>
                                                ))}
                                            </div>
                                            
                                            {/* Allocation Sliders */}
                                            <div className="mt-4 space-y-4">
                                                <div>
                                                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                        <Percent className="inline w-4 h-4 mr-1" />
                                                        US / International Split {guidedPortfolios[selectedPortfolio].hasBonds && `(${stockAllocation}% stocks)`}
                                                    </label>
                                                    <div className="flex items-center gap-4">
                                                        <span className="text-sm font-medium text-blue-600 w-16">{usAllocation}% US</span>
                                                        <input
                                                            type="range"
                                                            min="0"
                                                            max={stockAllocation}
                                                            value={usAllocation}
                                                            onChange={(e) => setUsAllocation(Number(e.target.value))}
                                                            className="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                                        />
                                                        <span className="text-sm font-medium text-green-600 w-24">{internationalAllocation}% Intl</span>
                                                    </div>
                                                </div>
                                                
                                                {guidedPortfolios[selectedPortfolio].hasBonds && (
                                                    <div className="bg-amber-50 border-2 border-amber-200 rounded-lg p-4">
                                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                            🏛️ Bond Allocation
                                                        </label>
                                                        <div className="flex items-center gap-4 mb-2">
                                                            <span className="text-sm font-medium text-amber-700 w-20">{bondAllocation}% Bonds</span>
                                                            <input
                                                                type="range"
                                                                min="0"
                                                                max="80"
                                                                value={bondAllocation}
                                                                onChange={(e) => setBondAllocation(Number(e.target.value))}
                                                                className="flex-1 h-2 bg-amber-200 rounded-lg appearance-none cursor-pointer"
                                                            />
                                                            <span className="text-sm font-medium text-blue-600 w-24">{stockAllocation}% Stocks</span>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        
                                        {/* Rebalancing Recommendations */}
                                        <div className="mt-6 p-4 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-300 rounded-lg">
                                            <h4 className="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                                <TrendingUp className="w-5 h-5 text-green-600" />
                                                Rebalancing Recommendations
                                            </h4>
                                            
                                            <div className="mb-3 text-sm text-gray-700 bg-white p-3 rounded-lg border border-green-200">
                                                <p className="mb-1"><span className="font-semibold">How this works:</span> We compare your current holdings to your target allocation to show which positions need adjustment.</p>
                                                <p>• <span className="font-semibold">Buy amounts</span> show how much to add to underweight positions</p>
                                                <p>• <span className="font-semibold">Sell amounts</span> show how much to remove from overweight positions</p>
                                            </div>
                                            
                                            {(() => {
                                                // Use Rule of 110 based on AGE as primary factor
                                                // Then consider time horizon as secondary adjustment
                                                
                                                const userAge = age || 30;
                                                
                                                // Rule of 110: 110 - age = % in stocks
                                                const rule110StockPercent = Math.max(0, Math.min(100, 110 - userAge));
                                                const rule110BondPercent = 100 - rule110StockPercent;
                                                
                                                // Also calculate Rule of 120 (more aggressive, modern approach)
                                                const rule120StockPercent = Math.max(0, Math.min(100, 120 - userAge));
                                                
                                                // Use Rule of 120 for younger investors (under 50), Rule of 110 for older
                                                let baseStockPercent, baseBondPercent, ruleUsed;
                                                if (userAge < 50) {
                                                    baseStockPercent = rule120StockPercent;
                                                    baseBondPercent = 100 - rule120StockPercent;
                                                    ruleUsed = "120";
                                                } else {
                                                    baseStockPercent = rule110StockPercent;
                                                    baseBondPercent = rule110BondPercent;
                                                    ruleUsed = "110";
                                                }
                                                
                                                // Adjust based on time horizon if significantly different
                                                let recommendedStockPercent = baseStockPercent;
                                                let recommendedBondPercent = baseBondPercent;
                                                let allocationRationale;
                                                
                                                // Time horizon adjustments
                                                if (timeHorizon < 5 && baseStockPercent > 60) {
                                                    // Very short horizon - cap stocks at 60%
                                                    recommendedStockPercent = 60;
                                                    recommendedBondPercent = 40;
                                                    allocationRationale = `Age ${userAge} suggests ${baseStockPercent}% stocks (Rule of ${ruleUsed}), but your ${timeHorizon}-year time horizon is very short. Capping at 60% stocks to protect against volatility when you'll need the funds soon.`;
                                                } else if (timeHorizon >= 30 && userAge < 40 && baseStockPercent < 100) {
                                                    // Very long horizon + young - can be 100% stocks
                                                    recommendedStockPercent = 100;
                                                    recommendedBondPercent = 0;
                                                    allocationRationale = `Age ${userAge} with a ${timeHorizon}-year time horizon means you can handle maximum volatility. 100% stocks maximizes long-term growth potential.`;
                                                } else {
                                                    allocationRationale = `Based on age ${userAge} using Rule of ${ruleUsed}: ${baseStockPercent}% stocks is appropriate. ${userAge < 40 ? 'You have time to ride out market volatility.' : userAge < 60 ? 'Balanced approach as you progress in your career.' : 'Increasing stability as you near retirement.'}`;
                                                }
                                                
                                                const currentStockPercent = usAllocation + internationalAllocation;
                                                const ageAlignmentDiff = currentStockPercent - recommendedStockPercent;
                                                const isAgeAppropriate = Math.abs(ageAlignmentDiff) <= 10;
                                                
                                                // Calculate target allocation based on selected portfolio
                                                const portfolio = guidedPortfolios[selectedPortfolio];
                                                const currentTotal = currentHoldings.reduce((sum, h) => sum + (h.amount || 0), 0);
                                                
                                                // Fund allocation mapping - categorize all funds by asset class
                                                const fundCategories = {
                                                    usTotalMarket: ['VTI', 'ITOT', 'SCHB', 'SPTM'],
                                                    usLargeCap: ['VOO', 'SPY', 'IVV', 'SCHX'],
                                                    usSmallCap: ['VB', 'IJR', 'SCHA'],
                                                    international: ['VXUS', 'VEA', 'VWO', 'SCHF', 'SCHE', 'IXUS', 'IEMG', 'SPEM'],
                                                    bonds: ['BND', 'AGG', 'BNDW']
                                                };
                                                
                                                // Metadata about fund types
                                                const fundTypeInfo = {
                                                    usTotalMarket: {
                                                        label: 'US Total Market',
                                                        description: 'Large, mid, and small-cap US stocks (~3,500+ companies)',
                                                        coverage: '100% of US market'
                                                    },
                                                    usLargeCap: {
                                                        label: 'US Large Cap (S&P 500)',
                                                        description: 'Top 500 largest US companies only',
                                                        coverage: '~80-85% of US market (missing small/mid caps)'
                                                    },
                                                    usSmallCap: {
                                                        label: 'US Small Cap',
                                                        description: 'Smaller US companies',
                                                        coverage: '~10-15% of US market'
                                                    }
                                                };
                                                
                                                // Calculate ACTUAL current allocation by asset class
                                                const currentByCategory = { 
                                                    usTotalMarket: 0, 
                                                    usLargeCap: 0, 
                                                    usSmallCap: 0,
                                                    international: 0, 
                                                    bonds: 0, 
                                                    stocks: 0, 
                                                    other: 0 
                                                };
                                                const holdingsByCategory = { 
                                                    usTotalMarket: [], 
                                                    usLargeCap: [], 
                                                    usSmallCap: [],
                                                    international: [], 
                                                    bonds: [], 
                                                    stocks: [], 
                                                    other: [] 
                                                };
                                                
                                                currentHoldings.forEach(holding => {
                                                    if (holding.amount > 0) {
                                                        const ticker = holding.ticker.toUpperCase();
                                                        let categorized = false;
                                                        
                                                        // Check if it's a known ETF category
                                                        for (const [category, tickers] of Object.entries(fundCategories)) {
                                                            if (tickers.includes(ticker)) {
                                                                currentByCategory[category] += holding.amount;
                                                                holdingsByCategory[category].push(holding);
                                                                categorized = true;
                                                                break;
                                                            }
                                                        }
                                                        
                                                        // If not categorized, check if it's a stock or other
                                                        if (!categorized) {
                                                            if (holding.type === 'stock') {
                                                                currentByCategory.stocks += holding.amount;
                                                                holdingsByCategory.stocks.push(holding);
                                                            } else {
                                                                currentByCategory.other += holding.amount;
                                                                holdingsByCategory.other.push(holding);
                                                            }
                                                        }
                                                    }
                                                });
                                                
                                                // Calculate total US stocks (all subcategories combined)
                                                const totalUsStocks = currentByCategory.usTotalMarket + currentByCategory.usLargeCap + currentByCategory.usSmallCap;
                                                const allUsHoldings = [...holdingsByCategory.usTotalMarket, ...holdingsByCategory.usLargeCap, ...holdingsByCategory.usSmallCap];
                                                
                                                // Calculate current percentages
                                                const currentPercentages = {
                                                    us: currentTotal > 0 ? (totalUsStocks / currentTotal) * 100 : 0,
                                                    usTotalMarket: currentTotal > 0 ? (currentByCategory.usTotalMarket / currentTotal) * 100 : 0,
                                                    usLargeCap: currentTotal > 0 ? (currentByCategory.usLargeCap / currentTotal) * 100 : 0,
                                                    usSmallCap: currentTotal > 0 ? (currentByCategory.usSmallCap / currentTotal) * 100 : 0,
                                                    international: currentTotal > 0 ? (currentByCategory.international / currentTotal) * 100 : 0,
                                                    bonds: currentTotal > 0 ? (currentByCategory.bonds / currentTotal) * 100 : 0,
                                                    stocks: currentTotal > 0 ? (currentByCategory.stocks / currentTotal) * 100 : 0
                                                };
                                                
                                                // Target percentages
                                                const targetPercentages = {
                                                    us: usAllocation,
                                                    international: internationalAllocation,
                                                    bonds: bondAllocation
                                                };
                                                
                                                // Calculate what needs to be adjusted
                                                const categoryRecommendations = [];
                                                
                                                // Determine what type of US fund the target portfolio uses
                                                const targetUsFund = portfolio.funds.find(f => f.allocation === 'us');
                                                const targetUsFundTicker = targetUsFund?.ticker || 'VTI';
                                                let targetUsFundType = 'usTotalMarket'; // default
                                                
                                                // Determine which category the target fund belongs to
                                                for (const [category, tickers] of Object.entries(fundCategories)) {
                                                    if (tickers.includes(targetUsFundTicker.toUpperCase())) {
                                                        if (category.startsWith('us')) {
                                                            targetUsFundType = category;
                                                        }
                                                        break;
                                                    }
                                                }
                                                
                                                // US allocation check
                                                const usDiff = targetPercentages.us - currentPercentages.us;
                                                const hasWrongUsFundType = currentPercentages.us > 0 && 
                                                    currentByCategory[targetUsFundType] === 0 &&
                                                    totalUsStocks > 0;
                                                
                                                if (Math.abs(usDiff) > 5 || hasWrongUsFundType) {
                                                    let reason = '';
                                                    let actionType = 'adjust';
                                                    
                                                    if (hasWrongUsFundType) {
                                                        // User has US stocks but wrong type
                                                        const currentUsTypes = [];
                                                        if (currentByCategory.usTotalMarket > 0) currentUsTypes.push('Total Market');
                                                        if (currentByCategory.usLargeCap > 0) currentUsTypes.push('Large Cap (S&P 500)');
                                                        if (currentByCategory.usSmallCap > 0) currentUsTypes.push('Small Cap');
                                                        
                                                        const targetTypeInfo = fundTypeInfo[targetUsFundType];
                                                        const currentTypeStr = currentUsTypes.join(' + ');
                                                        
                                                        if (targetUsFundType === 'usTotalMarket' && currentByCategory.usLargeCap > 0 && currentByCategory.usSmallCap === 0) {
                                                            reason = `You have ${currentTypeStr} funds (${allUsHoldings.map(h => h.ticker).join(', ')}), but your target uses ${targetUsFundTicker} (${targetTypeInfo.label}). ${targetTypeInfo.label} funds provide broader diversification with ${targetTypeInfo.coverage}. Your current holdings ${fundTypeInfo.usLargeCap.coverage}, missing small and mid-cap exposure which have historically provided higher growth potential.`;
                                                            actionType = 'exchange';
                                                        } else if (targetUsFundType === 'usLargeCap' && currentByCategory.usTotalMarket > 0) {
                                                            reason = `You have ${currentTypeStr} funds (${allUsHoldings.map(h => h.ticker).join(', ')}), but your target uses ${targetUsFundTicker} (${targetTypeInfo.label}). If you prefer large-cap focus, ${targetTypeInfo.label} funds have slightly lower volatility and focus on established companies.`;
                                                            actionType = 'exchange';
                                                        } else {
                                                            reason = `You have ${currentTypeStr} funds (${allUsHoldings.map(h => h.ticker).join(', ')}), but your target portfolio uses ${targetUsFundTicker}. Consider whether your current holdings match your diversification goals.`;
                                                            actionType = 'review';
                                                        }
                                                        
                                                        if (Math.abs(usDiff) > 5) {
                                                            if (usDiff > 0) {
                                                                reason += ` Additionally, you're underweight in US stocks overall (${currentPercentages.us.toFixed(1)}% vs ${targetPercentages.us.toFixed(0)}% target). Add ${targetUsFundTicker} to reach your target allocation.`;
                                                            } else {
                                                                reason += ` Additionally, you're overweight in US stocks overall (${currentPercentages.us.toFixed(1)}% vs ${targetPercentages.us.toFixed(0)}% target). Consider trimming your position.`;
                                                            }
                                                        }
                                                    } else if (usDiff > 0) {
                                                        reason = `You're underweight in US stocks. Target is ${targetPercentages.us.toFixed(0)}% but you only have ${currentPercentages.us.toFixed(1)}%. US stocks provide core portfolio growth and historically strong returns.`;
                                                    } else {
                                                        reason = `You're overweight in US stocks. Target is ${targetPercentages.us.toFixed(0)}% but you have ${currentPercentages.us.toFixed(1)}%. Reducing exposure helps balance risk across global markets.`;
                                                    }
                                                    
                                                    categoryRecommendations.push({
                                                        category: 'US Stocks',
                                                        currentPercent: currentPercentages.us,
                                                        targetPercent: targetPercentages.us,
                                                        currentAmount: totalUsStocks,
                                                        targetAmount: (currentTotal * targetPercentages.us) / 100,
                                                        difference: (currentTotal * usDiff) / 100,
                                                        action: hasWrongUsFundType ? actionType : (usDiff > 0 ? 'buy' : 'sell'),
                                                        recommendedFund: targetUsFundTicker,
                                                        reason: reason,
                                                        holdings: allUsHoldings,
                                                        fundTypeMismatch: hasWrongUsFundType,
                                                        targetFundType: targetUsFundType
                                                    });
                                                }
                                                
                                                // International allocation check
                                                const intlDiff = targetPercentages.international - currentPercentages.international;
                                                if (Math.abs(intlDiff) > 5) {
                                                    const preferredIntlFund = portfolio.funds.find(f => f.allocation === 'international')?.ticker || 'VXUS';
                                                    categoryRecommendations.push({
                                                        category: 'International Stocks',
                                                        currentPercent: currentPercentages.international,
                                                        targetPercent: targetPercentages.international,
                                                        currentAmount: currentByCategory.international,
                                                        targetAmount: (currentTotal * targetPercentages.international) / 100,
                                                        difference: (currentTotal * intlDiff) / 100,
                                                        action: intlDiff > 0 ? 'buy' : 'sell',
                                                        recommendedFund: preferredIntlFund,
                                                        reason: intlDiff > 0
                                                            ? `You're underweight in international stocks. Target is ${targetPercentages.international.toFixed(0)}% but you only have ${currentPercentages.international.toFixed(1)}%. International diversification reduces country-specific risk and captures global growth.`
                                                            : `You're overweight in international stocks. Target is ${targetPercentages.international.toFixed(0)}% but you have ${currentPercentages.international.toFixed(1)}%. Adjusting helps maintain your desired US/international balance.`,
                                                        holdings: holdingsByCategory.international
                                                    });
                                                }
                                                
                                                // Bonds allocation check
                                                const bondsDiff = targetPercentages.bonds - currentPercentages.bonds;
                                                const ageBondsDiff = recommendedBondPercent - currentPercentages.bonds;
                                                const shouldCheckAgeBonds = Math.abs(ageBondsDiff) > 10; // Flag if significantly off from age-based recommendation
                                                
                                                if (Math.abs(bondsDiff) > 5 || shouldCheckAgeBonds) {
                                                    const preferredBondFund = portfolio.funds.find(f => f.allocation === 'bonds')?.ticker || 'BND';
                                                    let reason = '';
                                                    
                                                    if (shouldCheckAgeBonds && Math.abs(bondsDiff) <= 5) {
                                                        // Target matches but age suggests different allocation
                                                        if (ageBondsDiff > 0) {
                                                            reason = `Based on age ${userAge} and the Rule of ${ruleUsed}, you should have ${recommendedBondPercent}% bonds but you have ${currentPercentages.bonds.toFixed(1)}%. ${userAge >= 60 ? 'At your age, bonds provide crucial portfolio stability and protect against market downturns when you have less time to recover.' : 'Adding bonds now helps reduce volatility as you age.'}`;
                                                        }
                                                    } else if (bondsDiff > 0) {
                                                        reason = `You're underweight in bonds. Target is ${targetPercentages.bonds.toFixed(0)}% but you only have ${currentPercentages.bonds.toFixed(1)}%. ${userAge >= 50 ? 'At age ' + userAge + ', bonds provide important stability.' : 'Bonds provide stability and reduce portfolio volatility.'}`;
                                                    } else {
                                                        reason = `You're overweight in bonds. Target is ${targetPercentages.bonds.toFixed(0)}% but you have ${currentPercentages.bonds.toFixed(1)}%. ${userAge < 40 ? 'At age ' + userAge + ', you have time to benefit from higher stock allocation for growth.' : 'Consider if this conservative allocation matches your goals.'}`;
                                                    }
                                                    
                                                    categoryRecommendations.push({
                                                        category: 'Bonds',
                                                        currentPercent: currentPercentages.bonds,
                                                        targetPercent: targetPercentages.bonds,
                                                        currentAmount: currentByCategory.bonds,
                                                        targetAmount: (currentTotal * targetPercentages.bonds) / 100,
                                                        difference: (currentTotal * bondsDiff) / 100,
                                                        action: shouldCheckAgeBonds && Math.abs(bondsDiff) <= 5 ? 'review' : (bondsDiff > 0 ? 'buy' : 'sell'),
                                                        recommendedFund: preferredBondFund,
                                                        reason: reason,
                                                        holdings: holdingsByCategory.bonds,
                                                        ageConsideration: shouldCheckAgeBonds
                                                    });
                                                }
                                                
                                                const toBuy = categoryRecommendations.filter(r => r.action === 'buy');
                                                const toSell = categoryRecommendations.filter(r => r.action === 'sell');
                                                const toExchange = categoryRecommendations.filter(r => r.action === 'exchange');
                                                const toReview = categoryRecommendations.filter(r => r.action === 'review' || r.action === 'adjust');
                                                const individualStocks = holdingsByCategory.stocks;
                                                
                                                return (
                                                    <div className="space-y-4">
                                                        {/* Current vs Target Overview */}
                                                        <div className="grid grid-cols-2 gap-4 mb-4">
                                                            <div className="bg-white rounded p-3 border border-gray-200">
                                                                <div className="text-xs text-gray-600 mb-1">Current Portfolio Value</div>
                                                                <div className="text-2xl font-bold text-gray-900">
                                                                    ${currentTotal.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                                                </div>
                                                            </div>
                                                            <div className="bg-white rounded p-3 border border-gray-200">
                                                                <div className="text-xs text-gray-600 mb-1">Total To Rebalance</div>
                                                                <div className="text-2xl font-bold text-green-600">
                                                                    ${Math.abs(categoryRecommendations.reduce((sum, r) => sum + Math.abs(r.difference), 0) / 2).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                                                </div>
                                                                <div className="text-xs text-gray-500 mt-1">Amount to buy or sell</div>
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Age-Based Allocation Recommendation (Rule of 110/120) */}
                                                        <div className={`rounded-lg border-2 p-4 mb-4 ${isAgeAppropriate ? 'bg-green-50 border-green-300' : 'bg-orange-50 border-orange-300'}`}>
                                                            <div className="flex items-start gap-2 mb-3">
                                                                <span className="text-xl">{isAgeAppropriate ? '✅' : '⚠️'}</span>
                                                                <div className="flex-1">
                                                                    <h5 className="font-semibold text-gray-800 mb-1">
                                                                        Age-Based Allocation Check (Age {userAge})
                                                                    </h5>
                                                                    <p className="text-sm text-gray-700 mb-2">
                                                                        {allocationRationale}
                                                                    </p>
                                                                </div>
                                                            </div>
                                                            
                                                            <div className="grid grid-cols-2 gap-3 mb-3">
                                                                <div className="bg-white rounded p-3 border border-gray-200">
                                                                    <div className="text-xs text-gray-600 mb-1">Your Current</div>
                                                                    <div className="text-lg font-bold text-gray-900">
                                                                        {currentStockPercent.toFixed(0)}% stocks / {bondAllocation.toFixed(0)}% bonds
                                                                    </div>
                                                                </div>
                                                                <div className="bg-white rounded p-3 border border-gray-200">
                                                                    <div className="text-xs text-gray-600 mb-1">Recommended (Age {userAge})</div>
                                                                    <div className="text-lg font-bold text-blue-700">
                                                                        {recommendedStockPercent}% stocks / {recommendedBondPercent}% bonds
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            {!isAgeAppropriate && (
                                                                <div className="bg-white rounded p-3 border-l-4 border-orange-400">
                                                                    <div className="text-sm font-semibold text-orange-900 mb-1">
                                                                        {ageAlignmentDiff > 0 ? '📊 Consider Reducing Stock Exposure' : '🚀 Consider Increasing Stock Exposure'}
                                                                    </div>
                                                                    <div className="text-sm text-gray-700">
                                                                        {ageAlignmentDiff > 0 ? (
                                                                            <>You're {ageAlignmentDiff.toFixed(0)}% more aggressive than the Rule of {ruleUsed} recommends for age {userAge}. 
                                                                            {userAge >= 60 ? ' As you approach retirement age, reducing stock exposure helps protect against market downturns when you have less time to recover.' : ' Consider gradually shifting toward bonds to better match your age.'}</>
                                                                        ) : (
                                                                            <>You're {Math.abs(ageAlignmentDiff).toFixed(0)}% more conservative than the Rule of {ruleUsed} recommends for age {userAge}. 
                                                                            {userAge < 40 ? ' At your age, higher stock allocation can maximize long-term growth potential. The Rule of 120 suggests ' + (120 - userAge) + '% stocks.' : ' You may be leaving growth potential on the table.'}</>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            )}
                                                            
                                                            {isAgeAppropriate && (
                                                                <div className="text-sm text-green-800 bg-white rounded p-2 border-l-4 border-green-400">
                                                                    <span className="font-semibold">✓ Age-appropriate:</span> Your stock/bond allocation aligns with the Rule of {ruleUsed} for age {userAge}.
                                                                </div>
                                                            )}
                                                        </div>
                                                        
                                                        {/* Current Allocation Breakdown */}
                                                        <div className="bg-white rounded-lg border-2 border-blue-200 p-4 mb-4">
                                                            <h5 className="font-semibold text-gray-800 mb-3">📊 Your Current Allocation</h5>
                                                            <div className="space-y-2">
                                                                {currentPercentages.us > 0 && (
                                                                    <>
                                                                        <div className="flex justify-between items-center text-sm p-2 bg-gray-50 rounded font-semibold">
                                                                            <span>🇺🇸 US Stocks (Total):</span>
                                                                            <span className={Math.abs(currentPercentages.us - targetPercentages.us) > 5 ? 'font-semibold text-orange-600' : 'text-green-600'}>
                                                                                {currentPercentages.us.toFixed(1)}% 
                                                                                <span className="text-gray-500 text-xs ml-1">(target: {targetPercentages.us.toFixed(0)}%)</span>
                                                                            </span>
                                                                        </div>
                                                                        {/* US Breakdown */}
                                                                        <div className="ml-4 space-y-1">
                                                                            {currentPercentages.usTotalMarket > 0 && (
                                                                                <div className="flex justify-between items-center text-xs p-2 bg-blue-50 rounded">
                                                                                    <span>↳ Total Market: {holdingsByCategory.usTotalMarket.map(h => h.ticker).join(', ')}</span>
                                                                                    <span className="text-gray-700">{currentPercentages.usTotalMarket.toFixed(1)}%</span>
                                                                                </div>
                                                                            )}
                                                                            {currentPercentages.usLargeCap > 0 && (
                                                                                <div className="flex justify-between items-center text-xs p-2 bg-blue-50 rounded">
                                                                                    <span>↳ Large Cap (S&P 500): {holdingsByCategory.usLargeCap.map(h => h.ticker).join(', ')}</span>
                                                                                    <span className="text-gray-700">{currentPercentages.usLargeCap.toFixed(1)}%</span>
                                                                                </div>
                                                                            )}
                                                                            {currentPercentages.usSmallCap > 0 && (
                                                                                <div className="flex justify-between items-center text-xs p-2 bg-blue-50 rounded">
                                                                                    <span>↳ Small Cap: {holdingsByCategory.usSmallCap.map(h => h.ticker).join(', ')}</span>
                                                                                    <span className="text-gray-700">{currentPercentages.usSmallCap.toFixed(1)}%</span>
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    </>
                                                                )}
                                                                {currentPercentages.international > 0 && (
                                                                    <div className="flex justify-between items-center text-sm p-2 bg-gray-50 rounded">
                                                                        <span>🌍 International Stocks:</span>
                                                                        <span className={Math.abs(currentPercentages.international - targetPercentages.international) > 5 ? 'font-semibold text-orange-600' : 'text-green-600'}>
                                                                            {currentPercentages.international.toFixed(1)}% 
                                                                            <span className="text-gray-500 text-xs ml-1">(target: {targetPercentages.international.toFixed(0)}%)</span>
                                                                        </span>
                                                                    </div>
                                                                )}
                                                                {currentPercentages.bonds > 0 && (
                                                                    <div className="flex justify-between items-center text-sm p-2 bg-gray-50 rounded">
                                                                        <span>💰 Bonds:</span>
                                                                        <span className={Math.abs(currentPercentages.bonds - targetPercentages.bonds) > 5 ? 'font-semibold text-orange-600' : 'text-green-600'}>
                                                                            {currentPercentages.bonds.toFixed(1)}% 
                                                                            <span className="text-gray-500 text-xs ml-1">(target: {targetPercentages.bonds.toFixed(0)}%)</span>
                                                                        </span>
                                                                    </div>
                                                                )}
                                                                {currentPercentages.stocks > 0 && (
                                                                    <div className="flex justify-between items-center text-sm p-2 bg-orange-50 rounded border border-orange-200">
                                                                        <span>⚠️ Individual Stocks:</span>
                                                                        <span className="font-semibold text-orange-600">
                                                                            {currentPercentages.stocks.toFixed(1)}%
                                                                        </span>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Overlapping Funds Warning */}
                                                        {(() => {
                                                            const usTypeHoldings = [
                                                                { type: 'Total Market', holdings: holdingsByCategory.usTotalMarket, count: holdingsByCategory.usTotalMarket.length },
                                                                { type: 'Large Cap (S&P 500)', holdings: holdingsByCategory.usLargeCap, count: holdingsByCategory.usLargeCap.length },
                                                                { type: 'Small Cap', holdings: holdingsByCategory.usSmallCap, count: holdingsByCategory.usSmallCap.length }
                                                            ];
                                                            const intlHoldings = holdingsByCategory.international;
                                                            const hasUsOverlap = usTypeHoldings.some(t => t.count > 1);
                                                            const hasIntlOverlap = intlHoldings.length > 1;
                                                            const hasMultipleUsTypes = usTypeHoldings.filter(t => t.count > 0).length > 1;
                                                            
                                                            if (!hasUsOverlap && !hasIntlOverlap && !hasMultipleUsTypes) return null;
                                                            
                                                            return (
                                                                <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-4">
                                                                    <div className="flex items-start gap-2">
                                                                        <span className="text-xl">💡</span>
                                                                        <div>
                                                                            <div className="font-semibold text-yellow-900 mb-2">Overlapping Holdings Detected</div>
                                                                            
                                                                            {/* Multiple funds of same US type */}
                                                                            {usTypeHoldings.map((typeGroup, idx) => {
                                                                                if (typeGroup.count > 1) {
                                                                                    return (
                                                                                        <div key={idx} className="text-sm text-yellow-800 mb-2">
                                                                                            <span className="font-semibold">US {typeGroup.type}:</span> You own {typeGroup.holdings.map(h => h.ticker).join(', ')}. 
                                                                                            These funds track virtually identical indexes with 99%+ overlap. Consider consolidating into one fund to simplify.
                                                                                        </div>
                                                                                    );
                                                                                }
                                                                                return null;
                                                                            })}
                                                                            
                                                                            {/* Multiple US types - complementary message */}
                                                                            {hasMultipleUsTypes && !hasUsOverlap && (
                                                                                <div className="text-sm text-yellow-800 mb-2">
                                                                                    <span className="font-semibold">Multiple US Stock Types:</span> You own {allUsHoldings.map(h => h.ticker).join(', ')}. 
                                                                                    {holdingsByCategory.usLargeCap.length > 0 && holdingsByCategory.usSmallCap.length > 0 && holdingsByCategory.usTotalMarket.length === 0 && (
                                                                                        <> Combining Large Cap + Small Cap creates similar exposure to a Total Market fund (like VTI) but with more complexity. Consider if the granular control is worth it.</>
                                                                                    )}
                                                                                    {holdingsByCategory.usTotalMarket.length > 0 && (holdingsByCategory.usLargeCap.length > 0 || holdingsByCategory.usSmallCap.length > 0) && (
                                                                                        <> Your Total Market fund already includes large and small caps, making your other US funds redundant. Consider consolidating to just {holdingsByCategory.usTotalMarket[0].ticker}.</>
                                                                                    )}
                                                                                </div>
                                                                            )}
                                                                            
                                                                            {hasIntlOverlap && (
                                                                                <div className="text-sm text-yellow-800 mb-2">
                                                                                    <span className="font-semibold">International Holdings:</span> You own {intlHoldings.map(h => h.ticker).join(', ')}. These funds have significant overlap in international markets.
                                                                                </div>
                                                                            )}
                                                                            
                                                                            <div className="text-sm text-yellow-900 bg-white p-2 rounded border-l-4 border-yellow-400">
                                                                                <span className="font-semibold">Why this matters: </span>
                                                                                {(hasUsOverlap || hasIntlOverlap) && <>Holding multiple overlapping funds adds complexity without meaningful diversification benefit. You're paying multiple expense ratios for essentially the same market exposure. </>}
                                                                                Consider consolidating into a single fund per asset class for simplicity and lower costs.
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })()}
                                                        
                                                        {/* Individual Stock Warning */}
                                                        {individualStocks.length > 0 && (
                                                            <div className="bg-orange-100 border-2 border-orange-300 rounded-lg p-4">
                                                                <div className="flex items-start gap-2">
                                                                    <span className="text-xl">⚠️</span>
                                                                    <div>
                                                                        <div className="font-semibold text-orange-900 mb-1">Individual Stock Concentration Risk</div>
                                                                        <div className="text-sm text-orange-800 mb-2">
                                                                            You have ${individualStocks.reduce((sum, s) => sum + s.amount, 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} 
                                                                            ({((individualStocks.reduce((sum, s) => sum + s.amount, 0) / currentTotal) * 100).toFixed(1)}%) in individual stocks:
                                                                        </div>
                                                                        <ul className="text-sm text-orange-800 space-y-1 ml-4 mb-3">
                                                                            {individualStocks.map((stock, idx) => (
                                                                                <li key={idx}>
                                                                                    <span className="font-semibold">{stock.ticker}:</span> ${stock.amount.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} 
                                                                                    ({((stock.amount / currentTotal) * 100).toFixed(1)}%)
                                                                                </li>
                                                                            ))}
                                                                        </ul>
                                                                        <div className="text-sm text-orange-900 bg-white p-2 rounded border-l-4 border-orange-400 mb-2">
                                                                            <span className="font-semibold">Why this matters: </span>
                                                                            Individual stocks carry company-specific risk that ETFs don't have. If one company faces problems (management issues, industry disruption, accounting scandals), you could lose a significant portion of your portfolio. ETFs spread this risk across hundreds or thousands of companies.
                                                                        </div>
                                                                        <div className="text-sm text-orange-900 font-semibold">
                                                                            💡 Recommendation: Consider selling these stocks and reinvesting into diversified ETFs like {portfolio.funds.find(f => f.allocation === 'us')?.ticker || 'VTI'} to reduce concentration risk
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        )}
                                                        
                                                        {/* Buy Recommendations */}
                                                        {toBuy.length > 0 && (
                                                            <div className="bg-white rounded-lg border-2 border-green-300 p-4">
                                                                <div className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                                                    <span className="text-green-600">📈</span> Increase These Positions
                                                                </div>
                                                                <div className="space-y-4">
                                                                    {toBuy.map((rec, idx) => (
                                                                        <div key={idx} className="bg-green-50 rounded-lg p-3 border border-green-200">
                                                                            <div className="flex justify-between items-start mb-2">
                                                                                <div>
                                                                                    <div className="font-semibold text-gray-800">{rec.category}</div>
                                                                                    <div className="text-xs text-gray-600">Recommended: {rec.recommendedFund}</div>
                                                                                </div>
                                                                                <div className="text-right">
                                                                                    <div className="text-green-700 font-bold text-lg">
                                                                                        +${Math.abs(rec.difference).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                                                                    </div>
                                                                                    <div className="text-xs text-gray-600">
                                                                                        {rec.currentPercent.toFixed(1)}% → {rec.targetPercent.toFixed(0)}%
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                            <div className="text-sm text-gray-700 bg-white p-2 rounded border-l-4 border-green-400">
                                                                                <span className="font-semibold">Why: </span>{rec.reason}
                                                                            </div>
                                                                            {rec.holdings.length > 0 && (
                                                                                <div className="mt-2 text-xs text-gray-600">
                                                                                    <span className="font-semibold">You currently hold:</span> {rec.holdings.map(h => h.ticker).join(', ')}
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}
                                                        
                                                        {/* Sell Recommendations */}
                                                        {toSell.length > 0 && (
                                                            <div className="bg-white rounded-lg border-2 border-orange-300 p-4">
                                                                <div className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                                                    <span className="text-orange-600">📉</span> Reduce These Positions
                                                                </div>
                                                                <div className="space-y-4">
                                                                    {toSell.map((rec, idx) => (
                                                                        <div key={idx} className="bg-orange-50 rounded-lg p-3 border border-orange-200">
                                                                            <div className="flex justify-between items-start mb-2">
                                                                                <div>
                                                                                    <div className="font-semibold text-gray-800">{rec.category}</div>
                                                                                    <div className="text-xs text-gray-600">Sell from any of these holdings</div>
                                                                                </div>
                                                                                <div className="text-right">
                                                                                    <div className="text-orange-700 font-bold text-lg">
                                                                                        -${Math.abs(rec.difference).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                                                                    </div>
                                                                                    <div className="text-xs text-gray-600">
                                                                                        {rec.currentPercent.toFixed(1)}% → {rec.targetPercent.toFixed(0)}%
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                            <div className="text-sm text-gray-700 bg-white p-2 rounded border-l-4 border-orange-400">
                                                                                <span className="font-semibold">Why: </span>{rec.reason}
                                                                            </div>
                                                                            {rec.holdings.length > 0 && (
                                                                                <div className="mt-2 text-xs text-gray-600">
                                                                                    <span className="font-semibold">Sell from:</span> {rec.holdings.map(h => `${h.ticker} ($${h.amount.toLocaleString()})`).join(', ')}
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}
                                                        
                                                        {/* Exchange/Swap Recommendations */}
                                                        {toExchange.length > 0 && (
                                                            <div className="bg-white rounded-lg border-2 border-purple-300 p-4">
                                                                <div className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                                                    <span className="text-purple-600">🔄</span> Consider Exchanging Funds
                                                                </div>
                                                                <div className="space-y-4">
                                                                    {toExchange.map((rec, idx) => (
                                                                        <div key={idx} className="bg-purple-50 rounded-lg p-3 border border-purple-200">
                                                                            <div className="flex justify-between items-start mb-2">
                                                                                <div>
                                                                                    <div className="font-semibold text-gray-800">{rec.category}</div>
                                                                                    <div className="text-xs text-gray-600">
                                                                                        Exchange from: {rec.holdings.map(h => h.ticker).join(', ')} → {rec.recommendedFund}
                                                                                    </div>
                                                                                </div>
                                                                                <div className="text-right">
                                                                                    <div className="text-purple-700 font-bold text-sm">
                                                                                        Fund Mismatch
                                                                                    </div>
                                                                                    <div className="text-xs text-gray-600">
                                                                                        {rec.currentPercent.toFixed(1)}%
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                            <div className="text-sm text-gray-700 bg-white p-2 rounded border-l-4 border-purple-400">
                                                                                <span className="font-semibold">Why: </span>{rec.reason}
                                                                            </div>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}
                                                        
                                                        {/* Review Recommendations */}
                                                        {toReview.length > 0 && (
                                                            <div className="bg-white rounded-lg border-2 border-yellow-300 p-4">
                                                                <div className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                                                    <span className="text-yellow-600">💡</span> Review These Holdings
                                                                </div>
                                                                <div className="space-y-4">
                                                                    {toReview.map((rec, idx) => (
                                                                        <div key={idx} className="bg-yellow-50 rounded-lg p-3 border border-yellow-200">
                                                                            <div className="flex justify-between items-start mb-2">
                                                                                <div>
                                                                                    <div className="font-semibold text-gray-800">{rec.category}</div>
                                                                                    <div className="text-xs text-gray-600">
                                                                                        Current: {rec.holdings.map(h => h.ticker).join(', ')} | Target: {rec.recommendedFund}
                                                                                    </div>
                                                                                </div>
                                                                                <div className="text-right">
                                                                                    <div className="text-yellow-700 font-bold text-sm">
                                                                                        Review Needed
                                                                                    </div>
                                                                                    <div className="text-xs text-gray-600">
                                                                                        {rec.currentPercent.toFixed(1)}%
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                            <div className="text-sm text-gray-700 bg-white p-2 rounded border-l-4 border-yellow-400">
                                                                                <span className="font-semibold">Consider: </span>{rec.reason}
                                                                            </div>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}
                                                        
                                                        {toBuy.length === 0 && toSell.length === 0 && toExchange.length === 0 && toReview.length === 0 && individualStocks.length === 0 && (
                                                            <div className="text-center py-6">
                                                                <div className="text-4xl mb-2">✅</div>
                                                                <div className="text-lg font-semibold text-green-700">Portfolio is well-balanced!</div>
                                                                <div className="text-sm text-gray-600 mt-1">Your current allocation matches your target</div>
                                                            </div>
                                                        )}
                                                        
                                                        {/* Tax-Efficient Rebalancing Tip */}
                                                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-blue-800">
                                                            <div className="font-semibold mb-1">💡 Tax-Efficient Strategy:</div>
                                                            <ul className="space-y-1 ml-4 text-xs">
                                                                <li>• Use new contributions to buy underweight positions</li>
                                                                <li>• Sell from taxable accounts only if necessary (consider tax-loss harvesting)</li>
                                                                <li>• Prioritize rebalancing in tax-advantaged accounts (IRA, 401k)</li>
                                                                <li>• Aim to rebalance when drift exceeds 5% from target</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                );
                                            })()}
                                        </div>
                                        </>
                                    )}
                                </>
                            )}

                            {/* Growth Assumptions */}
                            <div className="mb-6">
                                {/* Expected Return Scenarios Display */}
                                <div className="mb-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg p-4">
                                    <div className="flex items-center justify-between mb-2">
                                        <div className="flex items-center gap-2">
                                            <TrendingUp className="w-5 h-5 text-blue-600" />
                                            <span className="font-semibold text-gray-800">Projected Returns (Based on Your Allocation)</span>
                                        </div>
                                        <div className="text-xs text-gray-600 bg-white px-2 py-1 rounded">
                                            {stockAllocation}% stocks / {bondAllocation}% bonds
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-center">
                                        <div className="bg-white rounded p-2 border border-orange-200">
                                            <div className="text-xs text-gray-600">🐢 Conservative</div>
                                            <div className="text-lg font-bold text-orange-600">{scenarios.conservative.toFixed(1)}%</div>
                                        </div>
                                        <div className="bg-white rounded p-2 border-2 border-blue-400">
                                            <div className="text-xs text-gray-600">🎯 Expected</div>
                                            <div className="text-lg font-bold text-blue-700">{scenarios.expected.toFixed(1)}%</div>
                                        </div>
                                        <div className="bg-white rounded p-2 border border-green-200">
                                            <div className="text-xs text-gray-600">🚀 Optimistic</div>
                                            <div className="text-lg font-bold text-green-600">{scenarios.optimistic.toFixed(1)}%</div>
                                        </div>
                                        <div className="bg-white rounded p-2 border border-red-300">
                                            <div className="text-xs text-gray-600">💥 Crisis</div>
                                            <div className="text-lg font-bold text-red-600">{scenarios.crisis.toFixed(1)}%</div>
                                        </div>
                                    </div>
                                    <p className="text-xs text-gray-600 mt-2">
                                        Returns calculated using: Stocks ~10%, Bonds ~4% (historical averages)
                                    </p>
                                </div>
                                
                                {/* Time Horizon */}
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                                        Time Horizon (Years)
                                    </label>
                                    <input
                                        type="number"
                                        value={timeHorizon}
                                        onChange={(e) => {
                                            const value = e.target.value;
                                            if (value === '') {
                                                setTimeHorizon(1);
                                            } else {
                                                const numValue = Number(value);
                                                setTimeHorizon(numValue);
                                            }
                                        }}
                                        onBlur={(e) => {
                                            const value = Number(e.target.value);
                                            if (value < 1) setTimeHorizon(1);
                                            if (value > 40) setTimeHorizon(40);
                                        }}
                                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                        min="1"
                                        max="40"
                                    />
                                </div>
                            </div>

                            {/* Dollar-Cost Averaging Section */}
                            <div className="border-t-2 border-gray-200 pt-6">
                                <h3 className="text-lg font-semibold text-gray-800 mb-4">💰 Dollar-Cost Averaging</h3>
                                <p className="text-sm text-gray-600 mb-4">Add regular contributions (daily, weekly, monthly, etc.) to see how consistently investing over time accelerates growth</p>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            Recurring Contribution Amount ($)
                                        </label>
                                        <input
                                            type="text"
                                            value={recurringContribution === 0 ? '' : recurringContribution}
                                            onChange={(e) => {
                                                const value = e.target.value.replace(/[^0-9]/g, '');
                                                setRecurringContribution(value === '' ? 0 : Number(value));
                                            }}
                                            className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                            placeholder="0"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            Contribution Frequency
                                        </label>
                                        <select
                                            value={contributionFrequency}
                                            onChange={(e) => setContributionFrequency(e.target.value)}
                                            className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                        >
                                            <option value="daily">Business Daily (Mon-Fri)</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="monthly">Monthly</option>
                                            <option value="quarterly">Quarterly</option>
                                            <option value="annually">Annually</option>
                                        </select>
                                    </div>
                                </div>

                                {recurringContribution > 0 && (
                                    <div className="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                        <p className="text-sm text-blue-800">
                                            <span className="font-semibold">Total contributions over {timeHorizon} years:</span> ${totalContributed.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                            {totalPortfolioValue > 0 
                                                ? ` ($${totalPortfolioValue.toLocaleString('en-US')} initial + $${(totalContributed - totalPortfolioValue).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} in recurring contributions)`
                                                : ` (All from ${contributionFrequency} contributions)`
                                            }
                                        </p>
                                    </div>
                                )}

                                {totalPortfolioValue === 0 && recurringContribution === 0 && mode !== 'rebalance' && (
                                    <div className="mt-3 p-3 bg-orange-50 rounded-lg border border-orange-200">
                                        <p className="text-sm text-orange-800">
                                            <span className="font-semibold">💡 Tip:</span> Set an initial investment amount or add recurring contributions to see your portfolio grow!
                                        </p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Results Grid */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            {/* Allocation Breakdown */}
                            <div className="bg-white rounded-2xl shadow-xl p-6">
                                <h2 className="text-xl font-bold text-gray-800 mb-4">Your Portfolio</h2>
                                
                                {totalPortfolioValue > 0 ? (
                                    <>
                                        <div className="h-64 mb-6 flex items-center justify-center">
                                            <canvas ref={chartRef} style={{maxHeight: '250px'}}></canvas>
                                        </div>

                                        <div className="space-y-4">
                                            {fundAllocations.map((fund, index) => {
                                                const borderColors = ['border-blue-500', 'border-indigo-500', 'border-green-500', 'border-emerald-500', 'border-yellow-500', 'border-red-500'];
                                                const bgColors = ['bg-blue-50', 'bg-indigo-50', 'bg-green-50', 'bg-emerald-50', 'bg-yellow-50', 'bg-red-50'];
                                                
                                                return (
                                                    <div key={index} className={`border-l-4 ${borderColors[index]} pl-4 py-2 ${bgColors[index]} rounded-r`}>
                                                        <div className="flex justify-between items-start mb-1">
                                                            <div className="text-sm text-gray-600 font-medium">{fund.ticker} - {fund.fullName}</div>
                                                            <span className="text-xs bg-white px-2 py-1 rounded font-semibold text-gray-700">{fund.provider}</span>
                                                        </div>
                                                        <div className="text-2xl font-bold text-gray-800">
                                                            ${fund.amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                                        </div>
                                                        <div className="text-xs text-gray-500 mt-2 grid grid-cols-1 sm:grid-cols-2 gap-x-3 gap-y-1">
                                                            <div><span className="font-semibold">Allocation:</span> {fund.percentage.toFixed(1)}%</div>
                                                            <div><span className="font-semibold">Fee:</span> {fund.expenseRatio}%</div>
                                                            <div><span className="font-semibold">Yield:</span> {fund.dividendYield}%</div>
                                                            <div><span className="font-semibold">Tax:</span> {fund.taxEfficiency}</div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </>
                                ) : (
                                    <div className="h-64 mb-6 flex items-center justify-center">
                                        <div className="text-center p-8 bg-gray-50 rounded-lg">
                                            <p className="text-gray-600 mb-2">No initial investment</p>
                                            <p className="text-sm text-gray-500">Your portfolio will build through recurring contributions</p>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Cost Analysis */}
                            <div className="bg-white rounded-2xl shadow-xl p-6">
                                <h2 className="text-xl font-bold text-gray-800 mb-4">Cost Analysis</h2>
                                
                                <div className="space-y-6">
                                    <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl">
                                        <div className="text-sm text-gray-600 mb-1">Weighted Expense Ratio</div>
                                        <div className="text-4xl font-bold text-blue-600">
                                            {weightedExpenseRatio.toFixed(3)}%
                                        </div>
                                        <div className="text-xs text-gray-500 mt-2">Blended annual cost</div>
                                    </div>

                                    <div>
                                        <div className="flex justify-between items-center mb-3">
                                            <span className="text-sm font-semibold text-gray-700">Annual Costs Breakdown</span>
                                        </div>
                                        
                                        <div className="space-y-3">
                                            {fundAllocations.map((fund, index) => (
                                                <div key={index} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                                    <span className="text-sm text-gray-600">{fund.ticker} annual fee</span>
                                                    <span className="font-semibold text-gray-800">
                                                        ${fund.cost.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                                    </span>
                                                </div>
                                            ))}
                                            
                                            <div className="flex justify-between items-center p-3 bg-blue-100 rounded-lg border-2 border-blue-300">
                                                <span className="text-sm font-bold text-gray-800">Total Annual Cost</span>
                                                <span className="text-lg font-bold text-blue-600">
                                                    ${totalCost.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-orange-50 p-4 rounded-lg border border-orange-200">
                                        <div className="flex items-start gap-2">
                                            <Info className="w-5 h-5 text-orange-600 mt-0.5 flex-shrink-0" />
                                            <div>
                                                <div className="text-sm font-semibold text-orange-900 mb-1">Lost to Fees Over {timeHorizon} Years</div>
                                                <div className="text-2xl font-bold text-orange-600">
                                                    ${totalFeesLost.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                                </div>
                                                <div className="text-xs text-orange-700 mt-1">
                                                    Growth you're giving up to expenses
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-red-50 p-3 rounded-lg border-2 border-red-300">
                                        <div className="flex items-start gap-2">
                                            <Info className="w-4 h-4 text-red-600 mt-0.5 flex-shrink-0" />
                                            <div className="flex-1">
                                                <div className="text-sm font-semibold text-red-900 mb-1">Cost of 1% Financial Advisor Fee</div>
                                                <div className="text-2xl font-bold text-red-600">
                                                    ${totalAdvisorFeesLost.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                                </div>
                                                <div className="text-xs text-red-700 mt-1">
                                                    Additional cost vs. self-managing these ETFs
                                                </div>
                                                <div className="mt-2 pt-2 border-t border-red-200">
                                                    <div className="text-xs text-gray-700">
                                                        Self-managing saves you {((totalAdvisorFeesLost / (totalAdvisorFeesLost + totalFeesLost)) * 100).toFixed(1)}% in total costs
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Growth Projection */}
                        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">Growth Projection</h2>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                                <div className="bg-blue-50 p-4 rounded-lg">
                                    <div className="text-sm text-gray-600 mb-1">Total Invested</div>
                                    <div className="text-2xl font-bold text-gray-800">
                                        ${totalContributed.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                    </div>
                                    <div className="text-xs text-gray-500 mt-1">
                                        Your contributions
                                    </div>
                                </div>
                                <div className="bg-green-50 p-4 rounded-lg">
                                    <div className="text-sm text-gray-600 mb-1">Projected Value ({timeHorizon} years)</div>
                                    <div className="text-2xl font-bold text-green-600">
                                        ${finalValue.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                    </div>
                                    <div className="text-xs text-gray-500 mt-1">
                                        Total portfolio value
                                    </div>
                                </div>
                                <div className="bg-purple-50 p-4 rounded-lg">
                                    <div className="text-sm text-gray-600 mb-1">Investment Growth</div>
                                    <div className="text-2xl font-bold text-purple-600">
                                        ${totalReturn.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                    </div>
                                    <div className="text-xs text-gray-500 mt-1">
                                        {totalContributed > 0 ? `${((totalReturn / totalContributed) * 100).toFixed(1)}% return` : 'N/A'}
                                    </div>
                                </div>
                                <div className="bg-indigo-50 p-4 rounded-lg">
                                    <div className="text-sm text-gray-600 mb-1">Growth vs Contributions</div>
                                    <div className="text-2xl font-bold text-indigo-600">
                                        {finalValue > 0 ? `${((totalReturn / finalValue) * 100).toFixed(1)}%` : '0%'}
                                    </div>
                                    <div className="text-xs text-gray-500 mt-1">
                                        From market growth
                                    </div>
                                </div>
                            </div>

                            {/* Earnings Breakdown */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div className="bg-teal-50 p-4 rounded-lg border-2 border-teal-200">
                                    <div className="text-sm text-gray-600 mb-1">💰 Estimated Dividend Income</div>
                                    <div className="text-2xl font-bold text-teal-600">
                                        ${totalDividends.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                    </div>
                                    <div className="text-xs text-gray-500 mt-1">
                                        Avg yield: {growthData.weightedDividendYield.toFixed(2)}% • Qualified dividends
                                    </div>
                                </div>
                                <div className="bg-amber-50 p-4 rounded-lg border-2 border-amber-200">
                                    <div className="text-sm text-gray-600 mb-1">📈 Estimated Capital Gains</div>
                                    <div className="text-2xl font-bold text-amber-600">
                                        ${capitalGains.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                    </div>
                                    <div className="text-xs text-gray-500 mt-1">
                                        {totalReturn > 0 ? `${((capitalGains / totalReturn) * 100).toFixed(1)}% of growth` : 'N/A'} • Long-term rate eligible
                                    </div>
                                </div>
                                <div className="bg-rose-50 p-4 rounded-lg border-2 border-rose-200">
                                    <div className="text-sm text-gray-600 mb-1">💸 Last Year Dividend Income</div>
                                    <div className="text-2xl font-bold text-rose-600">
                                        ${growthData.dividendIncome[growthData.dividendIncome.length - 1].toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                    </div>
                                    <div className="text-xs text-gray-500 mt-1">
                                        Annual income in year {timeHorizon}
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-4">
                                {/* Left side: Chart and Insights */}
                                <div className="lg:col-span-3 space-y-4">
                                    {/* Chart */}
                                    <div className="h-80">
                                        <canvas ref={growthChartRef}></canvas>
                                    </div>
                                    
                                    {/* Key Insights Cards */}
                                    <div className="grid grid-cols-2 gap-4">
                                        {/* Expected Return Range */}
                                        <div className="bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-200 rounded-lg p-5">
                                            <div className="text-xs text-gray-600 mb-2">📈 Expected Return</div>
                                            <div className="text-3xl font-bold text-blue-700 mb-1">
                                                {scenarios.expected.toFixed(1)}%
                                            </div>
                                            <div className="text-xs text-gray-500">
                                                Range: {scenarios.conservative.toFixed(1)}% - {scenarios.optimistic.toFixed(1)}%
                                            </div>
                                        </div>
                                        
                                        {/* Projected Value Range */}
                                        <div className="bg-gradient-to-br from-purple-50 to-purple-100 border-2 border-purple-200 rounded-lg p-5">
                                            <div className="text-xs text-gray-600 mb-2">💰 Final Value Range</div>
                                            <div className="text-2xl font-bold text-purple-700 mb-1">
                                                ${finalValue >= 1000000 
                                                    ? (finalValue / 1000000).toFixed(1) + 'M' 
                                                    : (finalValue / 1000).toFixed(0) + 'K'}
                                            </div>
                                            <div className="text-xs text-gray-500">
                                                ${(() => {
                                                    const conservativeVal = growthDataConservative.values[growthDataConservative.values.length - 1];
                                                    const optimisticVal = growthDataOptimistic.values[growthDataOptimistic.values.length - 1];
                                                    const formatVal = (val) => val >= 1000000 
                                                        ? (val / 1000000).toFixed(1) + 'M' 
                                                        : (val / 1000).toFixed(0) + 'K';
                                                    return `${formatVal(conservativeVal)} - ${formatVal(optimisticVal)} range`;
                                                })()}
                                            </div>
                                        </div>
                                        
                                        {/* Total Dividend Income */}
                                        <div className="bg-gradient-to-br from-amber-50 to-amber-100 border-2 border-amber-200 rounded-lg p-5">
                                            <div className="text-xs text-gray-600 mb-2">💵 Total Dividend Income</div>
                                            <div className="text-3xl font-bold text-amber-700 mb-1">
                                                ${totalDividends >= 1000000 
                                                    ? (totalDividends / 1000000).toFixed(1) + 'M' 
                                                    : (totalDividends / 1000).toFixed(0) + 'K'}
                                            </div>
                                            <div className="text-xs text-gray-500">
                                                Over {timeHorizon} years
                                            </div>
                                        </div>
                                        
                                        {/* Market Risk Level */}
                                        <div className="bg-gradient-to-br from-rose-50 to-rose-100 border-2 border-rose-200 rounded-lg p-5">
                                            <div className="text-xs text-gray-600 mb-2">🎲 Portfolio Risk</div>
                                            <div className="text-3xl font-bold text-rose-700 mb-1">
                                                {usAllocation >= 80 ? 'Moderate' : usAllocation >= 60 ? 'Balanced' : 'Conservative'}
                                            </div>
                                            <div className="text-xs text-gray-500">
                                                {usAllocation}% US / {internationalAllocation}% Intl
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Comparison to Average American */}
                                <div className="lg:col-span-2 bg-gradient-to-br from-emerald-50 to-teal-50 border-2 border-emerald-200 rounded-xl p-6 flex flex-col justify-between">
                                    <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                        <Sparkles className="w-5 h-5 text-emerald-600" />
                                        How You Compare
                                    </h3>
                                    
                                    {(() => {
                                        // Average US household retirement savings by age (2024 data)
                                        const usAverageSavings = {
                                            'Under 35': { median: 18880, average: 49130 },
                                            '35-44': { median: 45000, average: 141520 },
                                            '45-54': { median: 115000, average: 313220 },
                                            '55-64': { median: 185000, average: 537560 },
                                            '65-74': { median: 200000, average: 609230 },
                                            '75+': { median: 130000, average: 462410 }
                                        };
                                        
                                        // Estimate age bracket based on time horizon
                                        let projectedAge = '';
                                        let benchmarkData = { median: 0, average: 0 };
                                        
                                        if (timeHorizon <= 5) {
                                            projectedAge = 'Under 35';
                                            benchmarkData = usAverageSavings['Under 35'];
                                        } else if (timeHorizon <= 15) {
                                            projectedAge = '35-44';
                                            benchmarkData = usAverageSavings['35-44'];
                                        } else if (timeHorizon <= 25) {
                                            projectedAge = '45-54';
                                            benchmarkData = usAverageSavings['45-54'];
                                        } else if (timeHorizon <= 35) {
                                            projectedAge = '55-64';
                                            benchmarkData = usAverageSavings['55-64'];
                                        } else {
                                            projectedAge = '65-74';
                                            benchmarkData = usAverageSavings['65-74'];
                                        }
                                        
                                        // Calculate inflation-adjusted value for fair comparison to today's benchmarks
                                        const realValue = finalValue / Math.pow(1 + inflationRate, timeHorizon);
                                        const vsMedian = realValue / benchmarkData.median;
                                        const vsAverage = realValue / benchmarkData.average;
                                        
                                        // Calculate percentile (simplified approximation using real dollars)
                                        let percentile = 50;
                                        if (realValue >= benchmarkData.average) {
                                            percentile = 75 + Math.min(25, (realValue / benchmarkData.average - 1) * 10);
                                        } else if (realValue >= benchmarkData.median) {
                                            percentile = 50 + ((realValue - benchmarkData.median) / (benchmarkData.average - benchmarkData.median)) * 25;
                                        } else {
                                            percentile = (realValue / benchmarkData.median) * 50;
                                        }
                                        percentile = Math.min(99, Math.max(1, percentile));
                                        
                                        return (
                                            <>
                                                <div className="mb-6">
                                                    <div className="text-xs text-gray-600 mb-2">Your projected portfolio value:</div>
                                                    <div className="text-4xl font-bold text-emerald-600 mb-1">
                                                        ${finalValue >= 1000000 
                                                            ? (finalValue / 1000000).toFixed(1) + 'M' 
                                                            : (finalValue / 1000).toFixed(0) + 'K'}
                                                    </div>
                                                    <div className="text-xs text-gray-500">
                                                        in {timeHorizon} years
                                                        <span className="block text-emerald-700 font-semibold mt-1">
                                                            ≈ ${realValue >= 1000000 
                                                                ? (realValue / 1000000).toFixed(1) + 'M' 
                                                                : (realValue / 1000).toFixed(0) + 'K'} in today's dollars
                                                        </span>
                                                    </div>
                                                </div>
                                                
                                                <div className="mb-6 pb-6 border-b border-emerald-200">
                                                    <div className="text-xs text-gray-600 mb-2">Estimated Percentile:</div>
                                                    <div className="text-5xl font-bold text-emerald-700 mb-2">
                                                        {percentile.toFixed(0)}th
                                                    </div>
                                                    <div className="text-sm text-gray-600">
                                                        {percentile >= 75 ? '🎉 Top quartile!' : percentile >= 50 ? '✨ Above average' : '📈 Keep building'}
                                                    </div>
                                                </div>
                                                
                                                <div className="space-y-4 flex-grow">
                                                    {(() => {
                                                        // Helper function to format large numbers
                                                        const formatValue = (val) => {
                                                            if (val >= 1000000) {
                                                                return '$' + (val / 1000000).toFixed(1) + 'M';
                                                            } else {
                                                                return '$' + (val / 1000).toFixed(0) + 'K';
                                                            }
                                                        };
                                                        
                                                        return (
                                                            <>
                                                                <div>
                                                                    <div className="flex justify-between items-center mb-1">
                                                                        <span className="text-xs text-gray-600">US Median (Age {projectedAge})</span>
                                                                        <span className="text-xs font-semibold text-gray-700">{formatValue(benchmarkData.median)}</span>
                                                                    </div>
                                                                    <div className="w-full bg-gray-200 rounded-full h-2">
                                                                        <div 
                                                                            className="bg-blue-400 h-2 rounded-full" 
                                                                            style={{ width: '50%' }}
                                                                        ></div>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div>
                                                                    <div className="flex justify-between items-center mb-1">
                                                                        <span className="text-xs text-gray-600">You</span>
                                                                        <span className="text-xs font-bold text-emerald-700">{formatValue(realValue)}</span>
                                                                    </div>
                                                                    <div className="w-full bg-gray-200 rounded-full h-2">
                                                                        <div 
                                                                            className="bg-emerald-500 h-2 rounded-full" 
                                                                            style={{ width: Math.min(100, (realValue / benchmarkData.average) * 50) + '%' }}
                                                                        ></div>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div>
                                                                    <div className="flex justify-between items-center mb-1">
                                                                        <span className="text-xs text-gray-600">US Average (Age {projectedAge})</span>
                                                                        <span className="text-xs font-semibold text-gray-700">{formatValue(benchmarkData.average)}</span>
                                                                    </div>
                                                                    <div className="w-full bg-gray-200 rounded-full h-2">
                                                                        <div 
                                                                            className="bg-purple-400 h-2 rounded-full" 
                                                                            style={{ width: '100%' }}
                                                                        ></div>
                                                                    </div>
                                                                </div>
                                                            </>
                                                        );
                                                    })()}
                                                </div>
                                                
                                                <div className="mt-6 pt-6 border-t border-emerald-200">
                                                    <div className="text-sm text-gray-600">
                                                        {vsMedian >= 1 ? (
                                                            <>You'll have <span className="font-bold text-emerald-700">{vsMedian.toFixed(1)}x</span> the median savings</>
                                                        ) : (
                                                            <>Keep contributing to reach the median</>
                                                        )}
                                                    </div>
                                                </div>
                                            </>
                                        );
                                    })()}
                                </div>
                            </div>

                            <p className="text-xs text-gray-500 mt-4">
                                * Assumes {scenarios.expected.toFixed(1)}% expected annual return before fees (range: {scenarios.conservative.toFixed(1)}%-{scenarios.optimistic.toFixed(1)}%){recurringContribution > 0 ? `, with ${contributionFrequency} contributions of $${recurringContribution.toLocaleString('en-US')}` : ', no additional contributions'}. 
                                Dividend estimates based on current yields ({growthData.weightedDividendYield.toFixed(2)}% avg). US savings data from Federal Reserve Survey of Consumer Finances 2024. 
                                Comparisons use inflation-adjusted values (assuming {(inflationRate * 100).toFixed(0)}% annual inflation) for fair comparison to today's benchmarks. Past performance does not guarantee future results.
                            </p>
                        </div>

                        {/* Stress Test & Crisis Scenarios Section */}
                        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <div 
                                className="flex items-center justify-between cursor-pointer"
                                onClick={() => setStressTestExpanded(!stressTestExpanded)}
                            >
                                <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    🎲 Stress Test & Crisis Scenarios
                                    <span className="hidden sm:inline text-sm font-normal text-gray-600">
                                        How does your portfolio handle real-world disasters?
                                    </span>
                                </h2>
                                <button className="text-2xl text-gray-600 hover:text-gray-800">
                                    {stressTestExpanded ? '−' : '+'}
                                </button>
                            </div>
                            
                            {stressTestExpanded && (
                                <div className="mt-6">
                                    {/* Tab Navigation */}
                                    <div className="flex flex-wrap gap-2 mb-6 border-b-2 border-gray-200">
                                        <button
                                            onClick={() => setStressTestTab('historical')}
                                            className={`px-3 py-2 text-sm sm:text-base font-semibold transition-all ${
                                                stressTestTab === 'historical'
                                                    ? 'text-blue-600 border-b-2 border-blue-600 -mb-[2px]'
                                                    : 'text-gray-600 hover:text-gray-800'
                                            }`}
                                        >
                                            📊 Historical Crises
                                        </button>
                                        <button
                                            onClick={() => setStressTestTab('what-if')}
                                            className={`px-3 py-2 text-sm sm:text-base font-semibold transition-all ${
                                                stressTestTab === 'what-if'
                                                    ? 'text-blue-600 border-b-2 border-blue-600 -mb-[2px]'
                                                    : 'text-gray-600 hover:text-gray-800'
                                            }`}
                                        >
                                            💥 What-If Scenarios
                                        </button>
                                        <button
                                            onClick={() => setStressTestTab('vs-cash')}
                                            className={`px-3 py-2 text-sm sm:text-base font-semibold transition-all ${
                                                stressTestTab === 'vs-cash'
                                                    ? 'text-blue-600 border-b-2 border-blue-600 -mb-[2px]'
                                                    : 'text-gray-600 hover:text-gray-800'
                                            }`}
                                        >
                                            💵 vs. Cash/Inflation
                                        </button>
                                    </div>

                                    {/* Historical Crises Tab */}
                                    {stressTestTab === 'historical' && (
                                        <div className="space-y-4">
                                            <p className="text-sm text-gray-600 mb-4">
                                                See how your portfolio would perform through major historical market crashes, 
                                                then recover over the remaining years. Based on actual historical returns.
                                            </p>
                                            
                                            {/* 2008 Financial Crisis */}
                                            <div className="bg-gradient-to-r from-red-50 to-orange-50 border-2 border-red-200 rounded-lg p-5">
                                                <div className="flex items-center justify-between mb-3">
                                                    <h3 className="font-bold text-gray-800 text-lg">💣 2008 Financial Crisis</h3>
                                                    <span className="text-xs bg-red-100 px-2 py-1 rounded font-semibold text-red-700">
                                                        Actual Historical Returns
                                                    </span>
                                                </div>
                                                <p className="text-sm text-gray-700 mb-3">
                                                    Year 1: -37% crash, then gradual recovery. Used actual S&P 500 returns (2008-2017).
                                                </p>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <div className="text-xs text-gray-600">Final Value</div>
                                                        <div className="text-2xl font-bold text-red-700">
                                                            ${crisis2008.finalValue >= 1000000 
                                                                ? (crisis2008.finalValue / 1000000).toFixed(1) + 'M' 
                                                                : (crisis2008.finalValue / 1000).toFixed(0) + 'K'}
                                                        </div>
                                                        <div className="text-xs text-gray-500">
                                                            {((crisis2008.finalValue / finalValue - 1) * 100).toFixed(1)}% vs. expected
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs text-gray-600">Total Growth</div>
                                                        <div className="text-2xl font-bold text-green-600">
                                                            ${(crisis2008.finalValue - crisis2008.totalInvested) >= 1000000 
                                                                ? ((crisis2008.finalValue - crisis2008.totalInvested) / 1000000).toFixed(1) + 'M' 
                                                                : ((crisis2008.finalValue - crisis2008.totalInvested) / 1000).toFixed(0) + 'K'}
                                                        </div>
                                                        <div className="text-xs text-emerald-700 font-semibold">
                                                            ✓ Still grew despite crash!
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Dot-com Crash */}
                                            <div className="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-lg p-5">
                                                <div className="flex items-center justify-between mb-3">
                                                    <h3 className="font-bold text-gray-800 text-lg">🌐 Dot-com Crash (2000-2002)</h3>
                                                    <span className="text-xs bg-purple-100 px-2 py-1 rounded font-semibold text-purple-700">
                                                        Actual Historical Returns
                                                    </span>
                                                </div>
                                                <p className="text-sm text-gray-700 mb-3">
                                                    3 years of losses (-9%, -12%, -22%), then recovery. Tech bubble burst.
                                                </p>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <div className="text-xs text-gray-600">Final Value</div>
                                                        <div className="text-2xl font-bold text-purple-700">
                                                            ${crisisDotCom.finalValue >= 1000000 
                                                                ? (crisisDotCom.finalValue / 1000000).toFixed(1) + 'M' 
                                                                : (crisisDotCom.finalValue / 1000).toFixed(0) + 'K'}
                                                        </div>
                                                        <div className="text-xs text-gray-500">
                                                            {((crisisDotCom.finalValue / finalValue - 1) * 100).toFixed(1)}% vs. expected
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs text-gray-600">Total Growth</div>
                                                        <div className="text-2xl font-bold text-green-600">
                                                            ${(crisisDotCom.finalValue - crisisDotCom.totalInvested) >= 1000000 
                                                                ? ((crisisDotCom.finalValue - crisisDotCom.totalInvested) / 1000000).toFixed(1) + 'M' 
                                                                : ((crisisDotCom.finalValue - crisisDotCom.totalInvested) / 1000).toFixed(0) + 'K'}
                                                        </div>
                                                        <div className="text-xs text-emerald-700 font-semibold">
                                                            ✓ Recovered & grew!
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Great Depression */}
                                            <div className="bg-gradient-to-r from-gray-50 to-slate-100 border-2 border-gray-400 rounded-lg p-5">
                                                <div className="flex items-center justify-between mb-3">
                                                    <h3 className="font-bold text-gray-800 text-lg">🌑 Great Depression Style (1929-1933)</h3>
                                                    <span className="text-xs bg-gray-200 px-2 py-1 rounded font-semibold text-gray-700">
                                                        Modeled Historical Pattern
                                                    </span>
                                                </div>
                                                <p className="text-sm text-gray-700 mb-3">
                                                    4 years of catastrophic losses (-80% total), then slow recovery. Worst-case scenario.
                                                </p>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <div className="text-xs text-gray-600">Final Value</div>
                                                        <div className="text-2xl font-bold text-gray-700">
                                                            ${crisisDepression.finalValue >= 1000000 
                                                                ? (crisisDepression.finalValue / 1000000).toFixed(1) + 'M' 
                                                                : (crisisDepression.finalValue / 1000).toFixed(0) + 'K'}
                                                        </div>
                                                        <div className="text-xs text-gray-500">
                                                            {((crisisDepression.finalValue / finalValue - 1) * 100).toFixed(1)}% vs. expected
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs text-gray-600">Total Growth</div>
                                                        <div className="text-2xl font-bold text-orange-600">
                                                            ${(crisisDepression.finalValue - crisisDepression.totalInvested) >= 1000000 
                                                                ? ((crisisDepression.finalValue - crisisDepression.totalInvested) / 1000000).toFixed(1) + 'M' 
                                                                : ((crisisDepression.finalValue - crisisDepression.totalInvested) / 1000).toFixed(0) + 'K'}
                                                        </div>
                                                        <div className="text-xs text-orange-700 font-semibold">
                                                            {crisisDepression.finalValue > crisisDepression.totalInvested ? '✓ Still grew overall' : '⚠ Minimal growth'}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mt-4">
                                                <p className="text-sm text-blue-800">
                                                    <strong>💡 Key Insight:</strong> Even through the worst market crashes in history, 
                                                    staying invested + regular contributions = recovery. Time in the market beats timing the market.
                                                </p>
                                            </div>
                                        </div>
                                    )}

                                    {/* What-If Scenarios Tab */}
                                    {stressTestTab === 'what-if' && (
                                        <div className="space-y-4">
                                            <p className="text-sm text-gray-600 mb-4">
                                                Test specific portfolio risks mentioned: small-cap wipeout, bond crisis, international collapse. 
                                                See how diversification protects you.
                                            </p>

                                            {/* Small-Cap Wipeout */}
                                            <div className="bg-gradient-to-r from-amber-50 to-yellow-50 border-2 border-amber-300 rounded-lg p-5">
                                                <h3 className="font-bold text-gray-800 text-lg mb-2">📉 Small-Cap Wipeout (-60%)</h3>
                                                <p className="text-sm text-gray-700 mb-3">
                                                    What if small-cap stocks crash 60%? Your {usAllocation}% US allocation protects you.
                                                </p>
                                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                                    <div>
                                                        <div className="text-xs text-gray-600">Immediate Impact</div>
                                                        <div className="text-xl font-bold text-red-600">
                                                            {whatIfSmallCap.impactPercent.toFixed(1)}%
                                                        </div>
                                                        <div className="text-xs text-gray-500">Portfolio loss</div>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs text-gray-600">Final Value</div>
                                                        <div className="text-xl font-bold text-amber-700">
                                                            ${whatIfSmallCap.finalValue >= 1000000 
                                                                ? (whatIfSmallCap.finalValue / 1000000).toFixed(1) + 'M' 
                                                                : (whatIfSmallCap.finalValue / 1000).toFixed(0) + 'K'}
                                                        </div>
                                                        <div className="text-xs text-gray-500">After recovery</div>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs text-gray-600">vs Expected</div>
                                                        <div className="text-xl font-bold text-blue-600">
                                                            {((whatIfSmallCap.finalValue / finalValue - 1) * 100).toFixed(1)}%
                                                        </div>
                                                        <div className="text-xs text-emerald-700 font-semibold">Diversification helps!</div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Bond Crisis */}
                                            <div className="bg-gradient-to-r from-rose-50 to-red-50 border-2 border-rose-300 rounded-lg p-5">
                                                <h3 className="font-bold text-gray-800 text-lg mb-2">📈 Bond Crisis (Rates Spike +5%)</h3>
                                                <p className="text-sm text-gray-700 mb-3">
                                                    What if interest rates spike and bonds drop 20%? Your {bondAllocation}% bond allocation limits damage.
                                                </p>
                                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                                    <div>
                                                        <div className="text-xs text-gray-600">Immediate Impact</div>
                                                        <div className="text-xl font-bold text-red-600">
                                                            {whatIfBondCrisis.impactPercent.toFixed(1)}%
                                                        </div>
                                                        <div className="text-xs text-gray-500">Portfolio loss</div>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs text-gray-600">Final Value</div>
                                                        <div className="text-xl font-bold text-rose-700">
                                                            ${whatIfBondCrisis.finalValue >= 1000000 
                                                                ? (whatIfBondCrisis.finalValue / 1000000).toFixed(1) + 'M' 
                                                                : (whatIfBondCrisis.finalValue / 1000).toFixed(0) + 'K'}
                                                        </div>
                                                        <div className="text-xs text-gray-500">After recovery</div>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs text-gray-600">vs Expected</div>
                                                        <div className="text-xl font-bold text-blue-600">
                                                            {((whatIfBondCrisis.finalValue / finalValue - 1) * 100).toFixed(1)}%
                                                        </div>
                                                        <div className="text-xs text-gray-500">Minimal impact</div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* International Collapse */}
                                            <div className="bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-300 rounded-lg p-5">
                                                <h3 className="font-bold text-gray-800 text-lg mb-2">🌍 International Collapse (VXUS → 0)</h3>
                                                <p className="text-sm text-gray-700 mb-3">
                                                    What if international markets go to zero? Your {internationalAllocation}% allocation is at risk.
                                                </p>
                                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                                    <div>
                                                        <div className="text-xs text-gray-600">Immediate Impact</div>
                                                        <div className="text-xl font-bold text-red-600">
                                                            {whatIfIntlCollapse.impactPercent.toFixed(1)}%
                                                        </div>
                                                        <div className="text-xs text-gray-500">Portfolio loss</div>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs text-gray-600">Final Value</div>
                                                        <div className="text-xl font-bold text-indigo-700">
                                                            ${whatIfIntlCollapse.finalValue >= 1000000 
                                                                ? (whatIfIntlCollapse.finalValue / 1000000).toFixed(1) + 'M' 
                                                                : (whatIfIntlCollapse.finalValue / 1000).toFixed(0) + 'K'}
                                                        </div>
                                                        <div className="text-xs text-gray-500">After recovery</div>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs text-gray-600">vs Expected</div>
                                                        <div className="text-xl font-bold text-blue-600">
                                                            {((whatIfIntlCollapse.finalValue / finalValue - 1) * 100).toFixed(1)}%
                                                        </div>
                                                        <div className="text-xs text-gray-500">US stocks carry you</div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Armageddon */}
                                            <div className="bg-gradient-to-r from-red-100 to-orange-100 border-4 border-red-500 rounded-lg p-5">
                                                <h3 className="font-bold text-gray-800 text-lg mb-2">💀 Armageddon (All Three At Once)</h3>
                                                <p className="text-sm text-gray-700 mb-3">
                                                    What if everything collapses simultaneously? Small-cap wipeout + bond crisis + international collapse.
                                                </p>
                                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                                    <div>
                                                        <div className="text-xs text-gray-600">Immediate Impact</div>
                                                        <div className="text-2xl font-bold text-red-700">
                                                            {whatIfArmageddon.impactPercent.toFixed(1)}%
                                                        </div>
                                                        <div className="text-xs text-red-600 font-semibold">Catastrophic loss</div>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs text-gray-600">Final Value</div>
                                                        <div className="text-2xl font-bold text-orange-700">
                                                            ${whatIfArmageddon.finalValue >= 1000000 
                                                                ? (whatIfArmageddon.finalValue / 1000000).toFixed(1) + 'M' 
                                                                : (whatIfArmageddon.finalValue / 1000).toFixed(0) + 'K'}
                                                        </div>
                                                        <div className="text-xs text-gray-500">After recovery</div>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs text-gray-600">vs Expected</div>
                                                        <div className="text-2xl font-bold text-blue-600">
                                                            {((whatIfArmageddon.finalValue / finalValue - 1) * 100).toFixed(1)}%
                                                        </div>
                                                        <div className="text-xs text-orange-700 font-semibold">
                                                            {whatIfArmageddon.finalValue > whatIfArmageddon.totalInvested ? 'Still beats contributions!' : 'Severe impact'}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="bg-green-50 border-2 border-green-300 rounded-lg p-4 mt-4">
                                                <p className="text-sm text-green-800">
                                                    <strong>🛡️ Key Insight:</strong> Even in catastrophic scenarios affecting specific asset classes, 
                                                    diversification limits your downside. No single allocation is exposed to total loss.
                                                </p>
                                            </div>
                                        </div>
                                    )}

                                    {/* vs Cash Tab */}
                                    {stressTestTab === 'vs-cash' && (
                                        <div className="space-y-4">
                                            <p className="text-sm text-gray-600 mb-4">
                                                Compare your portfolio to keeping money in cash or savings accounts. 
                                                Even in a crisis, staying invested beats cash losing to inflation.
                                            </p>

                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                {/* Your Portfolio (Crisis) */}
                                                <div className="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-lg p-5">
                                                    <h3 className="font-bold text-gray-800 mb-3">📊 Your Portfolio (Crisis Scenario)</h3>
                                                    <div className="text-3xl font-bold text-blue-700 mb-2">
                                                        ${(() => {
                                                            const val = growthDataCrisis.values[growthDataCrisis.values.length - 1];
                                                            return val >= 1000000 
                                                                ? (val / 1000000).toFixed(1) + 'M' 
                                                                : (val / 1000).toFixed(0) + 'K';
                                                        })()}
                                                    </div>
                                                    <div className="text-xs text-gray-600 mb-2">
                                                        {scenarios.crisis.toFixed(1)}% annual return
                                                    </div>
                                                    <div className="text-sm text-green-700 font-semibold">
                                                        {((growthDataCrisis.values[growthDataCrisis.values.length - 1] / growthDataCrisis.totalContributions[growthDataCrisis.totalContributions.length - 1]) * 100 - 100).toFixed(0)}% growth
                                                    </div>
                                                    <p className="text-xs text-gray-500 mt-2">
                                                        Even in severe downturn, you grow your money.
                                                    </p>
                                                </div>

                                                {/* Cash */}
                                                <div className="bg-gradient-to-br from-gray-50 to-slate-100 border-2 border-gray-300 rounded-lg p-5">
                                                    <h3 className="font-bold text-gray-800 mb-3">💵 Cash (0% Return)</h3>
                                                    <div className="text-3xl font-bold text-gray-700 mb-2">
                                                        ${(() => {
                                                            const val = cashScenario.values[cashScenario.values.length - 1];
                                                            return val >= 1000000 
                                                                ? (val / 1000000).toFixed(1) + 'M' 
                                                                : (val / 1000).toFixed(0) + 'K';
                                                        })()}
                                                    </div>
                                                    <div className="text-xs text-gray-600 mb-2">
                                                        0% annual return
                                                    </div>
                                                    <div className="text-sm text-gray-600 font-semibold">
                                                        0% growth (just contributions)
                                                    </div>
                                                    <p className="text-xs text-red-600 mt-2 font-semibold">
                                                        Losing ${(() => {
                                                            const val = finalValue - cashScenario.values[cashScenario.values.length - 1];
                                                            return val >= 1000000 
                                                                ? (val / 1000000).toFixed(1) + 'M' 
                                                                : (val / 1000).toFixed(0) + 'K';
                                                        })()} vs. invested portfolio
                                                    </p>
                                                </div>

                                                {/* Inflation Loss */}
                                                <div className="bg-gradient-to-br from-red-50 to-orange-50 border-2 border-red-300 rounded-lg p-5">
                                                    <h3 className="font-bold text-gray-800 mb-3">📉 Losing to Inflation</h3>
                                                    <div className="text-3xl font-bold text-red-700 mb-2">
                                                        ${(() => {
                                                            const val = inflationLoss.values[inflationLoss.values.length - 1];
                                                            return val >= 1000000 
                                                                ? (val / 1000000).toFixed(1) + 'M' 
                                                                : (val / 1000).toFixed(0) + 'K';
                                                        })()}
                                                    </div>
                                                    <div className="text-xs text-gray-600 mb-2">
                                                        -3% real return
                                                    </div>
                                                    <div className="text-sm text-red-700 font-semibold">
                                                        {((inflationLoss.values[inflationLoss.values.length - 1] / inflationLoss.totalContributions[inflationLoss.totalContributions.length - 1]) * 100 - 100).toFixed(0)}% loss
                                                    </div>
                                                    <p className="text-xs text-red-600 mt-2 font-semibold">
                                                        Losing ${(() => {
                                                            const val = finalValue - inflationLoss.values[inflationLoss.values.length - 1];
                                                            return val >= 1000000 
                                                                ? (val / 1000000).toFixed(1) + 'M' 
                                                                : (val / 1000).toFixed(0) + 'K';
                                                        })()} vs. invested portfolio
                                                    </p>
                                                </div>
                                            </div>

                                            <div className="bg-emerald-50 border-2 border-emerald-300 rounded-lg p-5">
                                                <h3 className="font-bold text-gray-800 text-lg mb-3">📈 The Bottom Line</h3>
                                                <div className="space-y-2 text-sm">
                                                    <p className="text-gray-700">
                                                        <strong>Crisis Portfolio vs. Cash:</strong> <span className="text-green-700 font-bold">
                                                            +${(() => {
                                                                const val = growthDataCrisis.values[growthDataCrisis.values.length - 1] - cashScenario.values[cashScenario.values.length - 1];
                                                                return val >= 1000000 
                                                                    ? (val / 1000000).toFixed(1) + 'M' 
                                                                    : (val / 1000).toFixed(0) + 'K';
                                                            })()} better
                                                        </span>
                                                    </p>
                                                    <p className="text-gray-700">
                                                        <strong>Crisis Portfolio vs. Inflation Loss:</strong> <span className="text-green-700 font-bold">
                                                            +${(() => {
                                                                const val = growthDataCrisis.values[growthDataCrisis.values.length - 1] - inflationLoss.values[inflationLoss.values.length - 1];
                                                                return val >= 1000000 
                                                                    ? (val / 1000000).toFixed(1) + 'M' 
                                                                    : (val / 1000).toFixed(0) + 'K';
                                                            })()} better
                                                        </span>
                                                    </p>
                                                    <p className="text-emerald-800 font-semibold mt-3">
                                                        ✅ Even in the worst market crisis, staying invested beats cash or losing to inflation!
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* Export Report Section */}
                        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">📧 Export Your Report</h2>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* Download PDF */}
                                <div className="border-2 border-blue-200 rounded-lg p-6 bg-blue-50">
                                    <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                        <Download className="w-5 h-5 text-blue-600" />
                                        Download PDF Report
                                    </h3>
                                    <p className="text-sm text-gray-600 mb-4">
                                        Generate a comprehensive PDF with your portfolio allocations, cost analysis, and growth projections.
                                    </p>
                                    <button
                                        onClick={generatePDF}
                                        disabled={isGeneratingPDF}
                                        className="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                    >
                                        <Download className="w-5 h-5" />
                                        {isGeneratingPDF ? 'Generating PDF...' : 'Download PDF Report'}
                                    </button>
                                </div>

                                {/* Email Report */}
                                <div className="border-2 border-green-200 rounded-lg p-6 bg-green-50">
                                    <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                        <Mail className="w-5 h-5 text-green-600" />
                                        Email Report to Yourself
                                    </h3>
                                    <p className="text-sm text-gray-600 mb-4">
                                        Receive a detailed investment report directly in your inbox with all your calculations and projections.
                                    </p>
                                    <input
                                        type="email"
                                        placeholder="your.email@example.com"
                                        value={userEmail}
                                        onChange={(e) => setUserEmail(e.target.value)}
                                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none mb-3 text-sm"
                                    />
                                    <button
                                        onClick={sendEmailReport}
                                        disabled={isSendingEmail}
                                        className={`w-full px-6 py-3 rounded-lg transition-colors font-semibold flex items-center justify-center gap-2 ${
                                            isSendingEmail 
                                                ? 'bg-gray-400 cursor-not-allowed' 
                                                : 'bg-green-600 hover:bg-green-700 text-white'
                                        }`}
                                    >
                                        <Mail className="w-5 h-5" />
                                        {isSendingEmail ? 'Sending...' : 'Send Report to Email'}
                                    </button>
                                </div>
                            </div>

                            <p className="text-xs text-gray-500 mt-4 text-center">
                                💡 Tip: Save these reports for your records or share with your financial advisor
                            </p>
                        </div>

                        {/* How We Calculate Your Projections */}
                        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <button
                                onClick={() => setProjectionsExpanded(!projectionsExpanded)}
                                className="w-full flex items-center justify-between text-left hover:bg-gray-50 -m-6 p-6 rounded-2xl transition-colors"
                            >
                                <h2 className="text-xl font-bold text-gray-800">🧮 How We Calculate Your Projections</h2>
                                <span className="text-2xl text-gray-600">
                                    {projectionsExpanded ? '−' : '+'}
                                </span>
                            </button>
                            
                            {projectionsExpanded && (
                                <div className="mt-4">
                            
                            <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-5 mb-4">
                                <h3 className="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                                    <Info className="w-5 h-5 text-blue-600" />
                                    Transparent Methodology
                                </h3>
                                <p className="text-sm text-gray-700 mb-3">
                                    We believe in complete transparency. Here's exactly how we calculate your projections:
                                </p>
                            </div>

                            <div className="space-y-4">
                                {/* Return Assumptions */}
                                <div className="border-l-4 border-green-500 pl-4">
                                    <h4 className="font-semibold text-gray-800 mb-2">1. Return Assumptions</h4>
                                    <div className="text-sm text-gray-600 space-y-1">
                                        <p><strong>Conservative (8%):</strong> Below historical average, accounts for lower-return periods</p>
                                        <p><strong>Expected (10%):</strong> Historical S&P 500 average return (1926-2024)</p>
                                        <p><strong>Optimistic (12%):</strong> Above-average market performance</p>
                                        <p><strong>Crisis (2.5%):</strong> Models severe bear market conditions</p>
                                        <p className="text-xs text-gray-500 mt-2">📚 Source: Historical S&P 500 returns, adjusted for inflation</p>
                                    </div>
                                </div>

                                {/* Compound Growth Formula */}
                                <div className="border-l-4 border-purple-500 pl-4">
                                    <h4 className="font-semibold text-gray-800 mb-2">2. Compound Growth Formula</h4>
                                    <div className="text-sm text-gray-600 space-y-2">
                                        <p>We use the standard compound interest formula with periodic contributions:</p>
                                        <div className="bg-gray-100 p-3 rounded font-mono text-xs">
                                            Future Value = Principal × (1 + r)^t + Σ[Contribution × (1 + r)^periods]
                                        </div>
                                        <p>Where:</p>
                                        <ul className="list-disc list-inside space-y-1 ml-2">
                                            <li><strong>r</strong> = Annual return rate (adjusted for expense ratio)</li>
                                            <li><strong>t</strong> = Time in years</li>
                                            <li><strong>periods</strong> = Number of contribution periods (daily/monthly/etc.)</li>
                                        </ul>
                                        <p className="text-xs text-gray-500 mt-2">Each contribution grows from the moment it's invested</p>
                                    </div>
                                </div>

                                {/* Expense Ratios */}
                                <div className="border-l-4 border-orange-500 pl-4">
                                    <h4 className="font-semibold text-gray-800 mb-2">3. Expense Ratios & Fees</h4>
                                    <div className="text-sm text-gray-600 space-y-2">
                                        <p><strong>How we handle costs:</strong></p>
                                        <ul className="list-disc list-inside space-y-1 ml-2">
                                            <li>ETF expense ratios are deducted from returns annually</li>
                                            <li>Example: 10% return - 0.03% fee = 9.97% net return</li>
                                            <li>Weighted average based on your allocation</li>
                                            <li>Compounds over time (fees reduce growth each year)</li>
                                        </ul>
                                        <div className="bg-orange-50 p-3 rounded mt-2">
                                            <p className="text-xs"><strong>Real Impact:</strong> On a $100K portfolio over 30 years at 10% return:</p>
                                            <p className="text-xs">• 0.03% fee → Lose ~$26K to fees</p>
                                            <p className="text-xs">• 1.00% fee → Lose ~$200K+ to fees</p>
                                        </div>
                                    </div>
                                </div>

                                {/* Dollar-Cost Averaging */}
                                <div className="border-l-4 border-blue-500 pl-4">
                                    <h4 className="font-semibold text-gray-800 mb-2">4. Dollar-Cost Averaging</h4>
                                    <div className="text-sm text-gray-600 space-y-2">
                                        <p>Regular contributions are modeled as:</p>
                                        <ul className="list-disc list-inside space-y-1 ml-2">
                                            <li>Added at the <strong>beginning</strong> of each period</li>
                                            <li>Immediately begin earning returns</li>
                                            <li>Frequency matters: more frequent = more compounding</li>
                                        </ul>
                                        <div className="bg-blue-50 p-3 rounded mt-2 text-xs">
                                            <p><strong>Example:</strong> $1,000/month contribution at 10% annual return:</p>
                                            <p>• Month 1: $1,000 grows for 12 months</p>
                                            <p>• Month 6: $1,000 grows for 6 months</p>
                                            <p>• Month 12: $1,000 grows for 0 months</p>
                                            <p className="mt-1">Each contribution has different growth time</p>
                                        </div>
                                    </div>
                                </div>

                                {/* Dividend Modeling */}
                                <div className="border-l-4 border-teal-500 pl-4">
                                    <h4 className="font-semibold text-gray-800 mb-2">5. Dividend Income</h4>
                                    <div className="text-sm text-gray-600 space-y-2">
                                        <p><strong>How dividends work:</strong></p>
                                        <ul className="list-disc list-inside space-y-1 ml-2">
                                            <li>Based on actual ETF dividend yields (1.5-3.2%)</li>
                                            <li>Calculated as % of portfolio value each year</li>
                                            <li>Assumed to be automatically reinvested</li>
                                            <li>Part of your total return (not extra)</li>
                                        </ul>
                                        <p className="text-xs text-gray-500 mt-2">📊 Dividend yields from current ETF data (updated periodically)</p>
                                    </div>
                                </div>

                                {/* Crisis Scenarios */}
                                <div className="border-l-4 border-red-500 pl-4">
                                    <h4 className="font-semibold text-gray-800 mb-2">6. Historical Crisis Modeling</h4>
                                    <div className="text-sm text-gray-600 space-y-2">
                                        <p><strong>Real historical data:</strong></p>
                                        <ul className="list-disc list-inside space-y-1 ml-2">
                                            <li><strong>2008 Crisis:</strong> Actual S&P 500 returns 2008-2017</li>
                                            <li><strong>Dot-com Crash:</strong> Actual returns 2000-2009</li>
                                            <li><strong>Depression:</strong> Modeled after 1929-1933 losses</li>
                                        </ul>
                                        <p className="text-xs text-gray-500 mt-2">Shows how portfolio performs in worst-case scenarios with continued contributions</p>
                                    </div>
                                </div>

                                {/* Inflation Adjustment */}
                                <div className="border-l-4 border-yellow-500 pl-4">
                                    <h4 className="font-semibold text-gray-800 mb-2">7. Inflation Adjustment</h4>
                                    <div className="text-sm text-gray-600 space-y-2">
                                        <p>For "today's dollars" calculations:</p>
                                        <ul className="list-disc list-inside space-y-1 ml-2">
                                            <li>Assume 3% annual inflation (historical average)</li>
                                            <li>Real Value = Nominal Value ÷ (1.03)^years</li>
                                            <li>Used for fair comparisons to current benchmarks</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-gray-50 border-2 border-gray-300 rounded-lg p-4 mt-6">
                                <h4 className="font-semibold text-gray-800 mb-2">⚠️ Important Disclaimers</h4>
                                <div className="text-xs text-gray-600 space-y-1">
                                    <p>• <strong>Not predictions:</strong> These are projections based on historical averages. Actual results will vary.</p>
                                    <p>• <strong>Past ≠ Future:</strong> Historical returns don't guarantee future performance.</p>
                                    <p>• <strong>Simplified model:</strong> Real markets have volatility, rebalancing costs, and tax implications not fully captured.</p>
                                    <p>• <strong>Educational only:</strong> Not financial advice. Consult a professional for personalized guidance.</p>
                                </div>
                            </div>
                            </div>
                            )}
                        </div>

                        {/* Why This Portfolio */}
                        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">Why Low-Cost Index Funds?</h2>
                            
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                <div className="bg-blue-50 p-4 rounded-lg">
                                    <h3 className="font-semibold text-gray-800 mb-2">✓ Ultra-Low Costs</h3>
                                    <p className="text-sm text-gray-600">
                                        These ETFs have expense ratios of 0.03-0.11%. Over decades, low fees compound into massive savings.
                                    </p>
                                </div>

                                <div className="bg-green-50 p-4 rounded-lg">
                                    <h3 className="font-semibold text-gray-800 mb-2">✓ Tax Efficient</h3>
                                    <p className="text-sm text-gray-600">
                                        ETFs create fewer taxable events than mutual funds. Low turnover means qualified dividend treatment.
                                    </p>
                                </div>

                                <div className="bg-purple-50 p-4 rounded-lg">
                                    <h3 className="font-semibold text-gray-800 mb-2">✓ Instant Diversification</h3>
                                    <p className="text-sm text-gray-600">
                                        2-3 funds give you exposure to thousands of companies globally. Simple, effective, proven.
                                    </p>
                                </div>

                                <div className="bg-orange-50 p-4 rounded-lg">
                                    <h3 className="font-semibold text-gray-800 mb-2">✓ Set & Forget</h3>
                                    <p className="text-sm text-gray-600">
                                        No need to pick stocks or time the market. Index investing beats most active managers long-term.
                                    </p>
                                </div>
                            </div>
                        </div>

                        {/* Tax Efficiency & Fees Explained */}
                        <div className="bg-white rounded-2xl shadow-xl p-6">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">📊 Understanding Fees & Tax Efficiency</h2>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div className="border-2 border-blue-200 rounded-lg p-4 bg-blue-50">
                                    <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                        💵 Expense Ratios
                                    </h3>
                                    <div className="space-y-2 text-sm text-gray-700">
                                        <p><span className="font-semibold">0.03%:</span> Exceptional (Vanguard, Schwab, iShares core funds)</p>
                                        <p><span className="font-semibold">0.04-0.06%:</span> Excellent (Most low-cost index ETFs)</p>
                                        <p><span className="font-semibold">0.07-0.11%:</span> Very good (International/emerging market funds)</p>
                                        <p className="text-xs text-gray-600 mt-2 pt-2 border-t border-blue-300">
                                            Example: On $10,000, a 0.03% fee costs $3/year vs. 1% = $100/year. Over 30 years with growth, that difference becomes ~$25,000!
                                        </p>
                                    </div>
                                </div>

                                <div className="border-2 border-green-200 rounded-lg p-4 bg-green-50">
                                    <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                        🏛️ Tax Efficiency Ratings
                                    </h3>
                                    <div className="space-y-2 text-sm text-gray-700">
                                        <p><span className="font-semibold">Excellent:</span> Low turnover (3-5%), minimal capital gains distributions</p>
                                        <p><span className="font-semibold">Very Good:</span> Moderate turnover (4-15%), occasional distributions</p>
                                        <p><span className="font-semibold">Good:</span> Higher turnover (8-15%), more frequent distributions</p>
                                        <p className="text-xs text-gray-600 mt-2 pt-2 border-t border-green-300">
                                            All these ETFs qualify for: (1) Qualified dividend tax rates (max 20% vs. ordinary income), (2) Long-term capital gains rates if held 1+ year
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="border-2 border-purple-200 rounded-lg p-4 bg-purple-50">
                                    <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                        🔄 Turnover Rate
                                    </h3>
                                    <p className="text-sm text-gray-700 mb-2">
                                        Percentage of holdings replaced annually. Lower is better for taxes.
                                    </p>
                                    <div className="space-y-1 text-sm text-gray-700">
                                        <p><span className="font-semibold">3-5%:</span> Very low (S&P 500, Total Market)</p>
                                        <p><span className="font-semibold">5-10%:</span> Low (International broad market)</p>
                                        <p><span className="font-semibold">10-15%:</span> Moderate (Small-cap, emerging markets)</p>
                                    </div>
                                </div>

                                <div className="border-2 border-teal-200 rounded-lg p-4 bg-teal-50">
                                    <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                        💰 Dividend Yields
                                    </h3>
                                    <p className="text-sm text-gray-700 mb-2">
                                        Annual dividend income as % of investment. Paid quarterly.
                                    </p>
                                    <div className="space-y-1 text-sm text-gray-700">
                                        <p><span className="font-semibold">1.3-1.5%:</span> US stocks (growth-focused)</p>
                                        <p><span className="font-semibold">3.0-3.3%:</span> International developed (value-focused)</p>
                                        <p><span className="font-semibold">3.4-3.7%:</span> Emerging markets (higher yield)</p>
                                    </div>
                                </div>
                            </div>

                            <div className="mt-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <div className="flex items-start gap-2">
                                    <Info className="w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0" />
                                    <div className="text-sm text-gray-700">
                                        <span className="font-semibold">Tax Tip:</span> In taxable accounts, these low-turnover ETFs minimize taxable events. 
                                        You only pay capital gains tax when YOU sell (not when the fund rebalances). Dividends are taxed annually but qualify for lower rates. 
                                        For tax-advantaged accounts (IRA, 401k), tax efficiency matters less since growth is tax-deferred.
                                    </div>
                                </div>
                            </div>

                            <div className="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <div className="flex items-start gap-2">
                                    <Info className="w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0" />
                                    <div className="text-sm text-gray-700">
                                        <span className="font-semibold">Disclaimer:</span> This calculator is for educational purposes only. 
                                        Projections are based on assumptions and past performance doesn't guarantee future results. 
                                        Tax treatment depends on your individual situation. Consider consulting a financial advisor and tax professional for personalized advice.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<InvestmentCalculator />);
    </script>
</body>
</html>